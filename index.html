<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
 <title>Dark Realms Fighter Builder</title>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      background: #0f1113;
      color: #e4e7eb;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 1.5rem 1rem 2rem;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .top-actions{
      display:flex;
      gap:0.5rem;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .top-actions .tab-pill,
    .top-actions .tab-pill-colour{
      border-radius: 999px;
      padding: 0.3rem 0.75rem;
      font-size: 0.85rem;
    }

.top-title {
      font-size: 1.4rem;
      font-weight: 600;
    }
    .points-box-inline {
      padding: 0.4rem 0.7rem;
      border-radius: 0.5rem;
      background: #061D26;
      border: 1px solid #3aa79f;
      font-weight: 600;
    }
    .card {
      background: #1E2024;  
      border-radius: 0.75rem;
      border: 1px solid #2a2d31;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
        position: relative;
    }
    .card h2 {
      margin: 0 0 0.75rem;
      font-size: 1.2rem;
    }

    /* Stats row + pills */
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .stat-pill {
      background: #141619;
      border: 1px solid #59A199;
      border-radius: 12px;
      padding: 0.45rem 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }
    .stat-pill-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9aa1a8;
      margin-bottom: 0.15rem;
    }
    .stat-pill-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
    }
    .stat-pill-value {
      font-weight: 600;
      font-size: 1.2rem;
    }
    .stat-btn-vert {
      width: 26px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #1f2937;
      color: #e5e7eb;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stat-btn-vert:hover {
      background: #374151;
    }

    /* Warlock block */
    .warlock-box {
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px solid #1f2937;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.5rem;
      align-items: center;
    }
    .warlock-option {
      font-size: 0.85rem;
    }
    .warlock-option input {
      margin-right: 0.3rem;
    }
    .warlock-note {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .summary-highlight {
      margin-top: 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Tabs under stats */
    .tabs-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.5rem 0 0.75rem;
    }
    .tab-pill {
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #141619;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
    }
      .tab-pill-colour {
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #3aa79f;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .tab-pill:hover {
      background: #030712;
    }
    .tab-pill.active {
      background: #3aa79f;
      color: #ffffff;
      border-color: #101213;
    }

    /* Generic lists (weapons, abilities, etc.) */
    .flex-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .column {
      flex: 1 1 0;
      min-width: 220px;
    }
    .item-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.9rem;
    }
    .item-row {
      padding: 0.35rem 0.5rem;
      border-radius: 0.5rem;
      background: #061D26;
      border: 1px solid #59A199;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .item-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }
    .item-main {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .item-name {
      font-weight: 600;
    }
    .item-detail {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.15rem;
    }
    .item-points {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .item-actions button {
      border: none;
      background: #3aa79f;
      color: #111827;
      padding: 0.25rem 0.55rem;
      border-radius: 0.375rem;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .item-actions button:hover {
      background: #ffffff;
    }
    .item-actions .remove-btn {
      background: #7f1d1d;
      color: #fecaca;
    }
    .item-actions .remove-btn:hover {
      background: #b91c1c;
    }

    /* Weapon upgrades in selected weapon rows */
    .weapon-upgrades {
      font-size: 0.75rem;
      color: #9ca3af;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.15rem;
    }
    .weapon-upgrades label {
      display: flex;
      align-items: center;
      gap: 0.15rem;
    }
    .weapon-upgrades input {
      width: 12px;
      height: 12px;
    }
/* Summary category pill */
.summary-pill {
  background: #141619;
  border: 1px solid #2a2d31;
  border-radius: 12px;
  padding: 0.7rem 1rem;
  margin-bottom: 0.75rem;
}

/* Underlined category titles */
.summary-category-title {
  font-size: 1rem;
  font-weight: 600;
  margin: 0 0 0.35rem;
  padding-bottom: 0rem;
  border-bottom: 1px solid #3aa79f;
  display: inline-block;
}
      /* Total Points inside Stats box */
.stats-total-container {
  width: 100%;
  display: flex;
  justify-content: flex-end;
  align-items: center;   /* ← centers vertically */
  margin-top: 0.3rem;
}
/* Row for the Total Points pill inside the stats card */
.stats-total-row {
  width: 100%;
  display: flex;
  justify-content: flex-end;
  margin-top: 0.5rem;
}

      /* Total Points pill inside stats card, floating top-right */
.stats-total-floating {
  position: absolute;
  top: 1rem;
  right: 1rem;
  padding: 0.25rem 0.6rem;
  border-radius: 10px;
  background: #061D26;
  border: 1px solid #3aa79f;
  font-weight: 600;
  font-size: 1rem;
  white-space: nowrap;
}


    /* Options as exactly 2 columns */
    .weapons-options-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
    }

    /* 3-column layout: 2/3 options (2 cards), 1/3 selected */
    .weapons-layout .options-column {
      flex: 2 1 0;
    }
    .weapons-layout .selected-column {
      flex: 1 1 0;
    }
  
/* Print only the generated card (avoid blank first page) */
@media print {

  /* Safari print: prevent right-side clipping */
  body.print-card-mode #generated-card-overlay{
    display: flex !important;
    justify-content: center !important;
    align-items: flex-start !important;
    overflow: visible !important;
  }

  body.print-card-mode { background: transparent !important;  margin:0 !important; padding:0 !important; }

  @page { margin: 0; }
  body.print-card-mode .app { display: none !important; }
  body.print-card-mode #generated-card-overlay {
    display: block !important;
    position: static !important;
    inset: auto !important;
    background: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  body.print-card-mode #generated-card-overlay .card-wrap{
    margin: 0 auto !important;
    box-shadow: none !important;
    transform: none !important;
  
    transform: scale(0.95) !important;
    -webkit-transform: scale(0.95) !important;
    transform-origin: top center !important;
    page-break-inside: avoid !important;
  
    transform: scale(0.95) !important;
    transform-origin: top center !important;
    page-break-inside: avoid !important;
  }
    -webkit-transform-origin: top center !important;
}


  /* Toolbar texture toggle */
  .cc-tex-toggle{
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-weight:800;
    font-size:12px;
    color:#111;
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(0,0,0,0.25);
    border-radius: 12px;
    padding: 6px 10px;
  }
  .cc-tex-toggle input{ accent-color: #111; }


    /* ===== Portrait Cropper Overlay ===== */
    #portrait-cropper-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.78);
      display: none;
      z-index: 99999;
      padding: 22px 14px;
      overflow: auto;
    }
    #portrait-cropper-overlay.show{ display:block; }
    #portrait-cropper-overlay .pc-modal{
      max-width: 1100px;
      margin: 0 auto;
      background: #1E2024;
      border: 1px solid #2a2d31;
      border-radius: 14px;
      padding: 14px;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    @media (max-width: 980px){
      #portrait-cropper-overlay .pc-modal{ grid-template-columns: 1fr; }
    }
    .pc-panel .pc-title{ font-size: 1.05rem; font-weight: 700; margin-bottom: 8px; }
    .pc-panel .pc-sub{ font-size: 0.85rem; color:#9aa1a8; line-height: 1.35; margin-bottom: 12px; }
    .pc-panel input[type="file"]{
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px dashed #2a2d31;
      background:#141619;
      color:#e4e7eb;
    }
    .pc-actions{ display:flex; gap:0.5rem; flex-wrap:wrap; margin-top: 10px; }
    .pc-stage{ position:relative; display:flex; justify-content:center; align-items:center; min-height: 520px; }
    #pc-canvas{
      width: 100%;
      max-width: 760px;
      height: auto;
      background:#0b0d12;
      border: 1px solid #2a2d31;
      border-radius: 16px;
      touch-action:none;
      display:block;
    }
    .pc-badge{
      position:absolute;
      top: 12px;
      left: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(20,22,25,.85);
      border: 1px solid #2a2d31;
      color:#9aa1a8;
      font-size: 0.82rem;
      backdrop-filter: blur(6px);
    }
    .pc-warn{
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,180,74,.35);
      background: rgba(255,180,74,.08);
      color: #ffd7a3;
      font-size: 0.85rem;
      line-height: 1.35;
    }

    /* ===== Fighter Card Portrait Placement ===== */
    .cc-portrait-wrap{
      width: 240px;
      height: 208px;
      margin-top: 10px;
      background: transparent;
    }
    .cc-portrait-img{
      width: 100%;
      height: 100%;
      object-fit: contain; /* preserves full 682×592 frame */
      display:block;
    }

</style>
</head>
<body>
  <div class="app">
    <header class="top-bar">
     <div class="top-title">Dark Realms Fighter Builder</div>
     <div class="top-actions">
       <button class="tab-pill-colour" id="btn-save-json" type="button">Save Profile</button>
       <label class="tab-pill" style="cursor:pointer;">
         Load Profile
         <input id="file-load-json" type="file" accept="application/json" hidden>
       </label>

       <button class="tab-pill" id="btn-portrait" type="button" title="Crop / set portrait" style="display:none">Portrait</button>     </div>
    </header>

    <main>
      <!-- Stats always visible -->
      <section id="section-stats"></section>

      <!-- Tabs for the rest -->
      <div id="section-tabs" class="tabs-row">
        <button class="tab-pill active" data-target="section-weapons-cc">Close Combat Weapons</button>
        <button class="tab-pill" data-target="section-weapons-ranged">Ranged Weapons</button>
        <button class="tab-pill" data-target="section-abilities">Fighter Abilities</button>
        <button class="tab-pill" data-target="section-leader">Leader Abilities</button>
        <button class="tab-pill" data-target="section-spells">Spells</button>
        <button class="tab-pill" data-target="section-equipment">Equipment</button>
        <button class="tab-pill" data-target="section-summary">Summary</button>
      </div>

      <!-- Tabbed sections -->
      <section id="section-weapons-cc"></section>
      <section id="section-weapons-ranged"></section>
      <section id="section-abilities"></section>
      <section id="section-leader"></section>
      <section id="section-spells"></section>
      <section id="section-equipment"></section>
      <section id="section-summary"></section>
    </main>
  </div>

  
  <!-- Portrait Cropper Overlay -->
  <div id="portrait-cropper-overlay" aria-hidden="true">
    <div class="pc-modal">
      <div class="pc-panel">
        <div class="pc-title">Triangle Portrait Cropper</div>
        <div class="pc-sub">Upload a photo, then <b>drag</b> to move and <b>scroll</b> (or pinch) to zoom. Output: <b>682×592</b>, triangle points <b>down</b>. Border: <b>2px</b> #D8E2D7.</div>

        <input id="pc-file" type="file" accept="image/*" />

        <div class="pc-actions">
          <button class="tab-pill" id="pc-fit" type="button">Fit</button>
          <button class="tab-pill" id="pc-reset" type="button">Reset</button>
        </div>

        <div class="pc-actions">
          <button class="tab-pill-colour" id="pc-use" type="button">Use Portrait</button>
          <button class="tab-pill" id="pc-close" type="button">Close</button>
        </div>

        <div id="pc-warn" class="pc-warn" style="display:none;"></div>
      </div>

      <div class="pc-stage">
        <div class="pc-badge" id="pc-badge">No image loaded • 682×592</div>
        <canvas id="pc-canvas" width="682" height="592"></canvas>
      </div>
    </div>
  </div>

<script>
  // Dark Realms card assets
  window.DARKREALMS_CARD_LOGO_URL = "img/darkrealmslogo.png";
  window.DARKREALMS_CARD_TEX_URL  = "img/darkrealmstextureparchment.jpg";

    (function () {
      // STAT + COST CONFIG
      var STAT_CONFIG = [
        { key: "move",  label: "Move",  unit: '"', base: 6, min: 5, max: 8,  upCost: 4, downCost: 4, lowerIsBetter: false },
        { key: "def",   label: "DEF",   unit: "+", base: 9, min: 5, max: 11, upCost: 1, downCost: 1, lowerIsBetter: true  },
        { key: "ap",    label: "AP",    unit: "",  base: 2, min: 2, max: 4,  upCost: 4, downCost: 4, lowerIsBetter: false },
        { key: "hp",    label: "HP",    unit: "",  base: 7, min: 3, max: 99, upCost: 1, downCost: 1, lowerIsBetter: false },
        { key: "atk",   label: "ATK",   unit: "",  base: 3, min: 3, max: 5,  upCost: 2, downCost: 0, lowerIsBetter: false },
        { key: "fight", label: "Fight", unit: "+", base: 7, min: 5, max: 11, upCost: 2, downCost: 1, lowerIsBetter: true  },
        { key: "shoot", label: "Shoot", unit: "+", base: 7, min: 5, max: 11, upCost: 2, downCost: 1, lowerIsBetter: true  }
      ];

      // CLOSE COMBAT WEAPONS (example)
     var CC_WEAPONS = [
  {
    id: "fistsClaws",
    name: "Fists/Claws",
    profile: "ATK User, Hit User, DMG 2/3",
    points: 0
  },
  {
    id: "knife",
    name: "Knife",
    profile: "ATK User, Hit User, DMG 3/3",
    points: 1
  },
  {
    id: "beastClawsBite",
    name: "Beast Claws/Bite",
    profile: "ATK User, Hit User, DMG 3/4",
    points: 2
  },
  {
    id: "bladeAxe",
    name: "Blade/Axe",
    profile: "ATK User, Hit User, DMG 3/4",
    points: 2
  },
  {
    id: "bigBladeAxe",
    name: "Big Blade/Axe",
    profile: "ATK User, Hit User, DMG 3/5",
    points: 3
  },
  {
    id: "clubMace",
    name: "Club/Maze",
    profile: "ATK User, Hit User, DMG 4/4",
    points: 3
  },
  {
    id: "spear",
    name: "Spear",
    profile: 'ATK User, Hit User, DMG 3/3, Rng 2"',
    points: 3
  },
  {
    id: "staff",
    name: "Staff",
    profile: "ATK User, Hit User, DMG 4/4",
    points: 3
  },
  {
    id: "greatBlade",
    name: "Great Blade",
    profile: "ATK User, Hit User, DMG 4/5",
    points: 4
  },
  {
    id: "halberd",
    name: "Halberd",
    profile: 'ATK User, Hit User, DMG 3/4, Rng 2"',
    points: 4
  },
  {
    id: "twoHandedBlade",
    name: "Two Handed Blade",
    profile: "ATK User, Hit User, DMG 5/6",
    points: 5
  },
  {
    id: "hugeHammerAxeBlade",
    name: "Huge Hammer/Axe/Blade",
    profile: "ATK User, Hit User, DMG 5/6, Reroll (1)",
    points: 6
  },
  {
    id: "monstrousClaws",
    name: "Monstrous Claws",
    profile: "ATK User, Hit User, DMG 5/6, MW (1)",
    points: 6
  },
  {
    id: "flail",
    name: "Flail",
    profile: 'ATK User, Hit User-1, DMG 4/5, Rng 2"',
    points: 4
  },
  {
    id: "greatHammer",
    name: "Great Hammer",
    profile: "ATK User, Hit User-2, DMG 5/7, Reroll (SR)",
    points: 7
  }
];


      // RANGED WEAPONS (example)
      var RANGED_WEAPONS = [
  {
    id: "blackpowderPistol",
    name: "Blackpowder Pistol",
    profile: 'ATK 4, Hit User, DMG 4/5, Rng 8", Piercing (-3), Risky',
    points: 4
  },
  {
    id: "blackpowderRifle",
    name: "Blackpowder Rifle",
    profile: "ATK 4, Hit User, DMG 4/5, Piercing (-3), Risky",
    points: 9
  },
  {
    id: "blunderbuss",
    name: "Blunderbuss",
    profile: 'ATK 4, Hit User+1, DMG 4/4, Rng 6"',
    points: 4
  },
  {
    id: "bow",
    name: "Bow",
    profile: "ATK 4, Hit User, DMG 3/4",
    points: 2
  },
  {
    id: "breathWeaponBeasts",
    name: "Breath Weapon (Beasts)",
    profile:
      'ATK 4, Hit User+2, DMG 3/4, Rng 6", Ignores Cover, Piercing (-2), Torrent (1"), Fire',
    points: 6
  },
  {
    id: "crossbow",
    name: "Crossbow",
    profile: "ATK 4, Hit User, DMG 3/4, Piercing Crits (-2)",
    points: 4
  },
  {
    id: "flamespurter",
    name: "Flamespurter",
    profile:
      'ATK 4, Hit User+2, DMG 3/4, Rng 6", Ignores Cover, Torrent (1"), Fire',
    points: 5
  },
  {
    id: "handCrossbow",
    name: "Hand Crossbow",
    profile:
      'ATK 4, Hit User, DMG 3/4, Rng 8", Piercing Crits (-2)',
    points: 3
  },
  {
    id: "longBow",
    name: "Long Bow",
    profile: "ATK 4, Hit User, DMG 4/5, Heavy (Dash)",
    points: 3
  },
  {
    id: "repeaterBlackpowderGun",
    name: "Repeater Blackpowder Gun",
    profile:
      "ATK 6, Hit User, DMG 4/4, Reroll (SR), Heavy (Dash), Piercing (-3), Risky",
    points: 10
  },
  {
    id: "repeatingCrossbow",
    name: "Repeating Crossbow",
    profile:
      "ATK 5, Hit User, DMG 4/5, Piercing Crits (-2), Heavy (Dash)",
    points: 7
  },
  {
    id: "rocketGun",
    name: "Rocket Gun",
    profile:
      'ATK 5, Hit User, DMG 4/5, Blast (1"), Heavy (Dash)',
    points: 8
  },
  {
    id: "sling",
    name: "Sling",
    profile:
      'ATK 4, Hit User, DMG 2/3, Rng 8"',
    points: 2
  },
  {
    id: "throwingKnives",
    name: "Throwing Knives",
    profile:
      'ATK 4, Hit User, DMG 3/4, Rng 6"',
    points: 3
  },
  {
    id: "thrownGlassOrbExplosive",
    name: "Thrown Glass Orb – Explosive",
    profile:
      'ATK 4, Hit User-2, DMG 2/4, Rng 6", Blast (2"), Ignores Cover',
    points: 6
  },
  {
    id: "thrownGlassOrbFire",
    name: "Thrown Glass Orb – Fire",
    profile:
      'ATK 4, Hit User-2, DMG 2/4, Rng 6", Torrent (1"), Ignores Cover, Fire',
    points: 6
  },
  {
    id: "thrownGlassOrbPoison",
    name: "Thrown Glass Orb – Poison",
    profile:
      'ATK 4, Hit User-2, DMG 4/5, Rng 6", Piercing (-2), Ignores Cover, Poison',
    points: 6
  },
  {
    id: "thrownRock",
    name: "Thrown Rock",
    profile:
      'ATK 4, Hit User, DMG 1/2, Rng 8"',
    points: 0
  },
  {
    id: "thrownSpear",
    name: "Thrown Spear (Javelin)",
    profile:
      'ATK 4, Hit User-1, DMG 3/4, Rng 12"',
    points: 4
  }
];


      // FIGHTER ABILITIES (example placeholder)
      var FIGHTER_ABILITIES = [
  {
    id: "counterstrike",
    name: "Counterstrike",
    points: 4,
    effect:
      "Each time an enemy Fighter deals this Fighter damage from an attack dice in Close Combat, this Fighter deals that Fighter 1 MW."
  },
  {
    id: "terrifying",
    name: "Terrifying",
    points: 3,
    effect:
      'Enemy Fighters within 1" of this Fighter have -2 to hit in Close Combat.'
  },
  {
    id: "expertGunfighter",
    name: "Expert Gunfighter",
    points: 4,
    effect:
      "This Fighter can make Shooting attacks with Pistols even while within 1\" of enemy Fighters."
  },
  {
    id: "expertDueller",
    name: "Expert Dueller",
    points: 4,
    effect:
      "This Fighter’s Close Combat weapons gain Reroll (SR)."
  },
  {
    id: "horrifyingDismemberment",
    name: "Horrifying Dismemberment",
    points: 2,
    effect:
      "When this Fighter slays an enemy in Close Combat, enemy Fighters within 6\" of the slain Fighter get -1 AP for the rest of the turn."
  },
  {
    id: "experiencedBrawler",
    name: "Experienced Brawler",
    points: 2,
    effect:
      "This Fighter does not suffer -2 to hit from being outnumbered in CC, and enemies do not gain +2 to hit from outnumbering this Fighter."
  },
  {
    id: "nullPariah",
    name: "Null / Pariah",
    points: 5,
    effect:
      "This Fighter cannot be targeted by Psychic Powers and cannot be a Psyker. Psykers (friend or foe) within 6\" cannot use Psychic Powers."
  },
  {
    id: "zealot",
    name: "Zealot",
    points: 3,
    effect:
      "When this Fighter fights in Close Combat after Charging this activation, it gains +1 to hit."
  },
  {
    id: "fast",
    name: "Fast",
    points: 2,
    effect:
      "This Fighter may perform a free Dash action during its activation (no AP cost)."
  },
  {
    id: "hyperAggressive",
    name: "Hyper Aggressive",
    points: 4,
    effect:
      "This Fighter may perform either 2 Shooting actions (Pistols/Light/Medium only) or 2 Close Combat actions during its activation."
  },
  {
    id: "gestaltMind",
    name: "Gestalt Mind",
    points: 2,
    effect:
      "This Fighter may share its AP with other Fighters in the Team that also have Gestalt Mind. When activating a Fighter, you may give 1 AP to another unactivated Gestalt Mind Fighter (max 4 AP on a Fighter)."
  },
  {
    id: "reanimation",
    name: "Reanimation",
    points: 4,
    effect:
      "When a Fighter with Reanimation is slain, place a token within 1\". At the start of each turn, on 5+ it is reanimated within 1\" with D3+2 HP and may act as normal. A Fighter can only be reanimated once; fail = leave the token and try next turn."
  },
  {
    id: "vengeance",
    name: "Vengeance",
    points: 2,
    effect:
      "When an enemy slays one of your Fighters, that enemy gains a Vengeance token. Fighters with Vengeance may turn one normal hit into a Crit when attacking an enemy with a Vengeance token. Remove the token when the enemy is slain; Vengeance tokens stack."
  },
  {
    id: "powerFromPain",
    name: "Power from Pain",
    points: 2,
    effect:
      "This Fighter gains a PfP token each time it injures or slays an enemy. During its activation it may spend PfP to: gain 1 AP (this turn), regain D3+1 HP, or gain Reroll (SR) on all weapons (this turn)."
  },
  {
    id: "ruthless",
    name: "Ruthless",
    points: 2,
    effect:
      "This Fighter may shoot at enemies locked in Combat. Any failed To Hit rolls of 1–2 hit the friendly model as normal damage."
  },
  {
    id: "regenerate",
    name: "Regenerate",
    points: 4,
    effect:
      "At the beginning of this Fighter’s activation, it regains D3+1 lost HP."
  },
  {
    id: "extremelyResilient",
    name: "Extremely Resilient",
    points: "+33% of HP Stat",
    dynamicType: "percentHp",
    dynamicFactor: 1/3,
    effect:
      "Whenever this Fighter takes damage from an attack, roll a D12 for each point of damage; on 9+ that point of damage is ignored."
  },
  {
    id: "unfetteredRage",
    name: "Unfettered Rage",
    points: 4,
    effect:
      "If this Fighter does not score any Critical Hits in Close Combat, you may change one normal hit to a Critical Hit."
  },
  {
    id: "noxiousPresence",
    name: "Noxious Presence",
    points: 4,
    effect:
      'Enemy Fighters within 3" reduce their DEF by 1. This stacks with other Noxious Presence auras.'
  },
  {
    id: "scarred",
    name: "Scarred",
    points: 3,
    effect:
      "Once per turn in Close Combat, this Fighter may lose 1 HP to reroll one attack die. If the reroll hits, add +1 Damage; if it misses, the Fighter loses 1 additional HP."
  },
  {
    id: "bornInDarkness",
    name: "Born in Darkness",
    points: 5,
    effect:
      'This Fighter cannot be targeted by Shooting attacks from 12" or more away, and cannot make Shooting attacks at targets 12" or more away.'
  },
  {
    id: "alchemist",
    name: "Alchemist",
    points: 3,
    effect:
      "Damage from Poison/Fire tokens applied by this Fighter’s weapons instead deals D3+1 damage."
  },
  {
    id: "trenchWarrior",
    name: "Trench Warrior",
    points: 4,
    effect:
      "This Fighter can use the Shoot action even while Hidden."
  },
  {
    id: "safeguard",
    name: "Safeguard",
    points: 3,
    effect:
      "Whenever this Fighter is within proximity of an Objective, its weapons gain Reroll (SR)."
  },
  {
    id: "gunslinger",
    name: "Gunslinger",
    points: 4,
    effect:
      "1 AP: If this Fighter has not yet used a Shoot action this activation, it may make two free Shooting actions with Pistol weapons."
  },
  {
    id: "headTaker",
    name: "Head-taker",
    points: 3,
    effect:
      "Whenever this Fighter kills an enemy in Melee, increase Crit Damage for all its Melee weapons by +2 for the rest of the battle."
  },
  {
    id: "overwatch",
    name: "Overwatch",
    points: 4,
    effect:
      'When an enemy ends a Move within 6" and visible (but not within 1"), this Fighter may immediately Shoot with -2 to hit. Counts as its Counteract action for the turn.'
  },
  {
    id: "endlessHorde",
    name: "Endless Horde",
    points: "= HP Stat",
    dynamicType: "hpStat",
    dynamicFactor: 1,
    effect:
      "Cost equals this Fighter’s current HP stat. When this Fighter dies, at the start of the next turn it returns at your Rearguard Deployment Zone edge. Only for Fighters with 2 AP or less and 10 HP or less."
  },
  {
    id: "volatileExpiration",
    name: "Volatile Expiration",
    points: 3,
    effect:
      "When this Fighter is slain, you may roll a D12 (subtract 2 if within 1\" of another enemy). On 6+, each Fighter within 2\" suffers D3 MW."
  },
  {
    id: "expendable",
    name: "Expendable",
    points: 3,
    effect:
      "When this Fighter dies, roll a D12; on 6+ you gain 1 FP."
  },
  {
    id: "agent",
    name: "Agent",
    points: 2,
    effect:
      "The AP cost of all Interact actions for this Fighter is reduced by 1 (to a minimum of 0)."
  },
  {
    id: "superhumanWarrior",
    name: "Superhuman Warrior",
    points: 10,
    effect:
      "This Fighter may perform 2 Shooting actions or 2 Close Combat actions in its activation. If using a Special/Heavy weapon, the second Shoot costs 2 AP. When Counteracting, it may perform 2 different actions."
  }
];


      // LEADER ABILITIES – 0 pts, max 2 selected
      var LEADER_ABILITIES = [
        {
          id: "inspiringPresence",
          name: "Inspiring Presence",
          points: 0,
          effect: '1 AP: Friendly Fighters within 3" of your Leader gain 1 AP until end of turn.'
        },
        {
          id: "masterTactician",
          name: "Master Tactician",
          points: 0,
          effect: "1 AP: You immediately gain 1 FP."
        },
        {
          id: "guidance",
          name: "Guidance",
          points: 0,
          effect: '1 AP: Choose a friendly Fighter within Line of Sight. That Fighter gains 1 AP until end of turn.'
        },
        {
          id: "grizzledVeteran",
          name: "Grizzled Veteran",
          points: 0,
          effect: "As long as this Fighter is on the battlefield, you can use the Tactical Reroll once per turn for 0 FP."
        },
        {
          id: "heroicLeader",
          name: "Heroic Leader",
          points: 0,
          effect: "May use a Feat for free once per turn, but only during this Fighter’s activation."
        },
        {
          id: "giveOrders",
          name: "Give Orders",
          points: 0,
          effect:
            '1 AP: All friendly Fighters within 6" gain ONE of the following (chosen once for all) until end of turn: +1 to Hit, +1" Charge range, or Hide action for 0 AP.'
        },
        {
          id: "noEscape",
          name: "No Escape",
          points: 0,
          effect:
            'Enemy Fighters within this Fighter’s melee range reduce their Move by 2" when performing a Fall Back action.'
        },
        {
          id: "getHimMark",
          name: "Get Him!",
          points: 0,
          effect:
            '1 AP: Select an enemy Fighter within Line of Sight. All shooting attacks against that Fighter gain Reroll (SR) until end of turn.'
        },
        {
          id: "perfectDuellist",
          name: "Perfect Duellist",
          points: 0,
          effect: "This Fighter can defend against Critical Hits in Close Combat using normal Defence rolls."
        },
        {
          id: "implacable",
          name: "Implacable",
          points: 0,
          effect: "This Fighter is immune to Glancing Hits."
        },
        {
          id: "impermeable",
          name: "Impermeable",
          points: 0,
          effect: "This Fighter is immune to effects from the Poison/Fire keyword."
        },
        {
          id: "infernal",
          name: "Infernal",
          points: 0,
          effect:
            "This Fighter’s weapons gain Poison/Fire. When attacking enemy Fighters that have a Poison/Fire token, the weapon’s Damage values are improved by +1/+1."
        },
        {
          id: "uncontrolledEruption",
          name: "Uncontrolled Eruption",
          points: 0,
          effect:
            '2 AP: Inflict D3+2 Mortal Wounds to each other Fighter that is within 2" and visible to this Fighter.'
        },
        {
          id: "whispersWarp",
          name: "Whispers of the Warp",
          points: 0,
          effect:
            'Whenever an opponent activates a Fighter within 6", roll a D6. If the result is higher than that Fighter’s AP, it loses 1 AP for this activation.'
        },
        {
          id: "spiritualPariah",
          name: "Spiritual Pariah",
          points: 0,
          effect:
            'Enemy Fighters within 6" and visible to this Fighter cannot reroll attack or defence rolls.'
        },
        {
          id: "mercilessOnslaught",
          name: "Merciless Onslaught",
          points: 0,
          effect:
            "1 AP: Activate before rolling to Hit with a Close Combat attack. For that attack, Glancing Hits deal 2 Damage."
        },
        {
          id: "getHimWarcry",
          name: "Get Him! (War Cry)",
          points: 0,
          effect:
            '2 AP: All friendly Fighters visible and within 6" gain EITHER (+2\" Move and +2 to Fight) OR (+2 to Shoot) until end of turn. ' +
            "Can only be used once per battle, and this Fighter is immediately Spent."
        },
        {
          id: "mindOnMission",
          name: "Mind on the Mission",
          points: 0,
          effect:
            'All friendly Fighters within 6" may use the Interact action for 0 AP.'
        },
        {
          id: "feedOnPain",
          name: "Feed on Pain",
          points: 0,
          effect:
            "If this Fighter slays an enemy Fighter with an attack, it regains 3 lost HP."
        }
      ];

      // SPELLS – no points, CV + layout with breaks
      var SPELLS = [
        {
          id: "tempest",
          name: "TEMPEST",
          cv: 13,
          points: 0,
          effect:
            'Range: 16"<br><br>' +
            'Target suffers D3 MW; roll a D12: on 11–12, push target D6" directly away and Knock Prone (loses 1 AP next activation).<br><br>' +
            "Flux Burn (CV 15): Deals +2 MW before the push."
        },
        {
          id: "graviticMaelstrom",
          name: "GRAVITIC MAELSTROM",
          cv: 17,
          points: 0,
          effect:
            'Range: 12", 3" AoE<br><br>' +
            'All models inside must roll 7+ or be dragged D3" toward the center and suffer D3 MW.<br><br>' +
            "Flux Burn (CV 19): Fighters dragged suffer D3+2 MW."
        },
        {
          id: "spectralChains",
          name: "SPECTRAL CHAINS",
          cv: 13,
          points: 0,
          effect:
            'Range: 16"<br><br>' +
            "Target suffers –2 Move and cannot Dash this round.<br><br>" +
            "Flux Burn (CV 15): Target also suffers 1 MW if it attempts a Charge."
        },
        {
          id: "stolenSight",
          name: "STOLEN SIGHT",
          cv: 12,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            "Target suffers –3 to Shoot until end of Round; if Engaged, suffers –2 to Fight instead.<br><br>" +
            "Flux Burn (CV 14): –4 to Shoot, –3 to Fight."
        },
        {
          id: "twistOfWill",
          name: "TWIST OF WILL",
          cv: 14,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            "Target must reroll all successful attack rolls on its next activation.<br><br>" +
            "Flux Burn (CV 16): Target also cannot Charge until next turn."
        },
        {
          id: "voidfireBlast",
          name: "VOIDFIRE BLAST",
          cv: 18,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            "Pick any point. All models within 2\" suffer 2D3 MW. Warlock suffers 1 MW.<br><br>" +
            "Flux Burn (CV 20): Radius becomes 4\"."
        },
        {
          id: "blazingWind",
          name: "BLAZING WIND",
          cv: 13,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            'Target suffers D3 Damage and is moved 2" directly away.<br><br>' +
            "Flux Burn (CV 15): D3+1 Damage and 4\" push."
        },
        {
          id: "fireblast",
          name: "FIREBLAST",
          cv: 13,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            "Target suffers D3+1 Damage.<br><br>" +
            "Flux Burn (CV 15): Target also gains a Fire token."
        },
        {
          id: "lightningBolt",
          name: "LIGHTNING BOLT",
          cv: 15,
          points: 0,
          effect:
            "Range: —<br><br>" +
            "Target suffers D3+2 MW.<br><br>" +
            "Flux Burn (CV 17): D3+3 MW."
        },
        {
          id: "mendFlesh",
          name: "MEND FLESH",
          cv: 10,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            "Restore D3+1 HP to a friendly Fighter.<br><br>" +
            "Flux Burn (CV 12): Restore D3+2 HP and remove 1 Poison/Burning token."
        },
        {
          id: "circleOfWarding",
          name: "CIRCLE OF WARDING",
          cv: 11,
          points: 0,
          effect:
            'Range: 3" aura<br><br>' +
            "Friendly Fighters inside gain +2 DEF (max 5+) and cannot be Charged this turn.<br><br>" +
            "Flux Burn (CV 13): Circle lasts until next activation."
        },
        {
          id: "arcaneAegis",
          name: "ARCANE AEGIS",
          cv: 13,
          points: 0,
          effect:
            'Range: 6"<br><br>' +
            "Target gains +2 DEF (max 5+) until next turn.<br><br>" +
            "Flux Burn (CV 15): Target ignores first 2 Damage from next attack."
        },
        {
          id: "spectralDecoy",
          name: "SPECTRAL DECOY",
          cv: 12,
          points: 0,
          effect:
            "Range: Self<br><br>" +
            "First attack against the Warlock before next activation automatically misses.<br><br>" +
            "Flux Burn (CV 14): On 5+, reflect that missed ranged attack for D3 Damage."
        },
        {
          id: "soulflameSurge",
          name: "SOULFLAME SURGE",
          cv: 16,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            'A friendly Fighter gains +1 ATK and “Crits on 9+” on CC weapons until end of Turn.<br><br>' +
            "Flux Burn (CV 16): Affect two Fighters instead of one."
        },
        {
          id: "veilOfShadows",
          name: "VEIL OF SHADOWS",
          cv: 14,
          points: 0,
          effect:
            'Range: 6"<br><br>' +
            "Target becomes Hidden, removed from engagement, placed up to 3\" away from enemies.<br><br>" +
            "Flux Burn (CV 16): Target may act normally; remove Hidden immediately."
        },
        {
          id: "reanimateTheDead",
          name: "REANIMATE THE DEAD",
          cv: 16,
          points: 0,
          effect:
            "Range: Self (3\" placement)<br><br>" +
            "Summon a Shambling Corpse (HP4, Move4\", Fight9+, AP1, ATK3, DMG2/3).<br><br>" +
            "Flux Burn (CV 18): Summon two instead."
        },
        {
          id: "phantasmalHorror",
          name: "PHANTASMAL HORROR",
          cv: 15,
          points: 0,
          effect:
            'Range: 12"<br><br>' +
            "Target must roll ≤ AP×2 on D12 or cannot Charge/move closer this turn.<br><br>" +
            "Flux Burn (CV 17): Must roll ≤ AP instead."
        },
        {
          id: "siphonLife",
          name: "SIPHON LIFE",
          cv: 14,
          points: 0,
          effect:
            'Range: 8"<br><br>' +
            "Target suffers D3 MW; Warlock heals the same amount.<br><br>" +
            "Flux Burn (CV 16): D3+2 MW/heal."
        },
        {
          id: "veilOfSouls",
          name: "VEIL OF SOULS",
          cv: 16,
          points: 0,
          effect:
            "Range: Self<br><br>" +
            "Until next activation, Warlock gains +1 DEF; enemies within 3\" suffer –1 to Hit.<br><br>" +
            "Flux Burn (CV 18): Warlock instead gains +2 DEF."
        },
        {
          id: "etherealBody",
          name: "ETHEREAL BODY",
          cv: 12,
          points: 0,
          effect:
            "Range: Self<br><br>" +
            "Move through models and terrain (cannot end inside them or within 1\" of enemies unless Charging).<br><br>" +
            "Flux Burn (CV 14): Also gain +2 DEF until next turn."
        }
      ];

      // EQUIPMENT (unchanged from previous working version)
      var EQUIPMENT = [
        {
          id: "healingPotions",
          name: "Healing Potions (+)",
          points: 4,
          effect: '1 AP: Friendly Fighter within 1" regains 2D3 lost HP.'
        },
        {
          id: "spotterFamiliar",
          name: "Spotter Familiar",
          points: 4,
          effect: "1 AP: Mark an enemy in LoS. Shooting vs that Fighter gains Reroll (SR) until next turn."
        },
        {
          id: "teleportArtifact",
          name: "Magical Teleport Artifact (+)",
          points: "+50% Stat cost",
          dynamicType: "percentStats",
          dynamicFactor: 0.5,
          effect:
            '1 AP: Reposition up to 12", ignoring terrain/height. Then roll D12; on 1–2 suffer D3 MW and may take no further actions this activation.'
        },
        {
          id: "flightDevice",
          name: "Magical Flight / Aerial Device / Wings",
          points: "+33% Stat cost",
          dynamicType: "percentStats",
          dynamicFactor: 1/3,
          effect:
            'Gains Jump Move: +3" Move and may ignore terrain and vertical height when repositioning.'
        },
        {
          id: "banner",
          name: "Banner (+)",
          points: 2,
          effect: 'Friendly Fighters within 3" gain +1 to Hit with CC and Shooting attacks.'
        },
        {
          id: "bomb",
          name: "Bomb (+)",
          points: 6,
          effect:
            "Once per game plant an Explosive Device while moving. 1 AP to detonate: ATK 4, Hit 2+, DMG 5/6, Piercing (-2), Blast (2\")."
        },
        {
          id: "climbingEquipment",
          name: "Climbing Equipment",
          points: 2,
          effect: 'Ignore the first 2" of vertical repositioning.'
        },
        {
          id: "ancientRelic",
          name: "Ancient Relic (+)",
          points: 3,
          effect: "User may ignore 1 normal damage attack per game."
        },
        {
          id: "enchantedCloak",
          name: "Enchanted Cloak",
          points: 4,
          effect:
            "User gains -1 to be hit when in Cover or Hidden (stacks with Cover/Hidden)."
        },
        {
          id: "arcaneShield",
          name: "Arcane Shield (+)",
          points: 5,
          effect: "User gains a 9+ Aegis save."
        },
        {
          id: "enhancingPotions",
          name: "Enhancing Potions",
          points: 4,
          effect:
            "At start of activation choose: (1) Heal 2D3 HP, (2) Reroll (SR) on CC attacks this turn, or (3) +2\" Move this turn."
        },
        {
          id: "rareArcaneShield",
          name: "Rare Arcane Shield (+)",
          points: 10,
          effect: "User gains a 7+ Aegis save."
        },
        {
          id: "heavilyMuscled",
          name: "Heavily Muscled",
          points: 3,
          effect: "User’s Heavy Weapons gain the “Heavy (Move)” Special Rule."
        },
        {
          id: "arcaneFamiliar",
          name: "Arcane Familiar",
          points: 4,
          effect:
            "1 AP: Mark an enemy in LoS. Shooting vs that Fighter ignores negative To Hit modifiers from Light Cover and Hidden until end of turn."
        },
        {
          id: "warHorn",
          name: "War Horn / Instrument (+)",
          points: 4,
          effect: '1 AP: Grant a friendly Fighter within 9" +1 AP this round.'
        },
        {
          id: "ringOfProtection",
          name: "Ring of Protection (+)",
          points: 4,
          effect:
            "User and friendly Fighters within 2\" reduce Piercing of enemy Shooting attacks by 2."
        },
        {
          id: "breachingRam",
          name: "Breaching Ram (+)",
          points: 5,
          effect:
            'Treat any wall <1" thick as Accessible Terrain (may move through at cost of 1" Move).'
        },
        {
          id: "clawedGloves",
          name: "Clawed Gloves (+)",
          points: 2,
          effect:
            "At the start of this Fighter’s CC activation, deal 2 MW to the engaged enemy Fighter."
        },
        {
          id: "magicalShield",
          name: "Magical Shield (+)",
          points: 5,
          effect:
            "User gains a 7+ Aegis save and 4 Defense dice in CC when using this shield. May only have Pistol and/or CC weapons as ranged options."
        },
        {
          id: "artifactOfDisruption",
          name: "Artifact of Disruption (+)",
          points: 5,
          effect:
            "1 AP: Select a visible enemy Fighter; that Fighter must be activated last by your opponent this turn."
        },
        {
          id: "grapplingHookGun",
          name: "Grappling Hook Gun (+)",
          points: 5,
          effect:
            '1 AP Move action: Place this Fighter within 1" of a chosen visible point on terrain, not within 1" of enemies. This Fighter may not have any Ranged Weapons.'
        },
        {
          id: "macabreMemento",
          name: "Macabre Memento (+)",
          points: 6,
          effect:
            'While visible and within 3" of enemy Fighters, those Fighters reduce the Attack characteristic of their Melee and Ranged weapons by 1.'
        },
        {
          id: "spottingTelescope",
          name: "Spotting Telescope (+)",
          points: 5,
          effect: "Gain 1 extra FP at the start of the battle."
        },
        {
          id: "blessedAmmunition",
          name: "Blessid / Tainted Ammunition (+)",
          points: 5,
          effect:
            "Add +1 to both Damage values of this Fighter’s Ranged weapons. Cannot be used on Heavy Weapons."
        },
        {
          id: "cannonsBehindLines",
          name: "Cannons Behind the Lines (+)",
          points: 14,
          effect:
            'Gain an additional Ranged weapon: Cannon Strike – ATK 4, Hit 6+, DMG 3/5, Blast (2"), Heavy (Dash), may be used while Hidden.'
        },
        {
          id: "telescopicSight",
          name: "Telescopic Sight",
          points: 3,
          effect:
            'This Fighter’s Ranged weapons with “Rng X” gain +1" range (except Flamers and Grenades).'
        },
        {
          id: "rope",
          name: "Rope",
          points: 3,
          effect: "This Fighter ignores vertical height when dropping down."
        },
        {
          id: "gorgetProtection",
          name: "Gorget Protection",
          points: 4,
          effect:
            "Enemy Fighters can only score Critical Hits on 11+ in CC against this Fighter."
        },
        {
          id: "scoutingIntel",
          name: "Scouting Intel",
          points: 4,
          effect:
            "Once per battle you may reroll the initiative roll. With Random Activation, return the drawn token and pull another."
        },
        {
          id: "voltaicSuit",
          name: "Voltaic Suit",
          points: 5,
          effect:
            'Whenever an enemy Fighter moves within 1", roll 3D12; for each 9+ that enemy suffers 1 MW.'
        }
      ];

      // FIGHTER STATE
      var fighter = {
        name: "",
        portraitDataUrl: "",
        stats: {},
        ccWeapons: [],
        rangedWeapons: [],
        abilities: [],
        leaderAbilities: [],
        spells: [],
        equipment: [],
        isWarlock: false,
        isMasterWarlock: false,
        points: {
          base: 16,
          stats: 0,
          warlock: 0,
          ccWeapons: 0,
          rangedWeapons: 0,
          abilities: 0,
          leaderAbilities: 0,
          spells: 0,
          equipment: 0
        }
      };

// === Cosmetic display-name overrides (builder + card) ===
function getDisplayName(item){
  if(!item) return "";
  var n = (item.displayNameOverride != null ? String(item.displayNameOverride) : "").trim();
  if(n) return n;
  return (item.name != null ? String(item.name) : "");
}
function setDisplayNameOverride(item, newName){
  if(!item) return;
  var n = (newName != null ? String(newName) : "").trim();
  if(n){
    item.displayNameOverride = n;
  } else {
    delete item.displayNameOverride;
  }
}
function promptRename(item, fallbackLabel){
  var current = (item && item.displayNameOverride) ? String(item.displayNameOverride) : "";
  var base = (item && item.name) ? String(item.name) : (fallbackLabel||"");
  var val = window.prompt("Rename for card (cosmetic only). Leave blank to reset.", current || base);
  if(val === null) return false; // cancelled
  setDisplayNameOverride(item, val);
  return true;
}

      // Expose state for card generator
      window.fighter = fighter;
      window.computeTotal = computeTotal;


      // TOTALS
      function computeTotal () {
        return fighter.points.base +
               fighter.points.stats +
               fighter.points.warlock +
               fighter.points.ccWeapons +
               fighter.points.rangedWeapons +
               fighter.points.abilities +
               fighter.points.leaderAbilities +
               fighter.points.spells +
               fighter.points.equipment;
      }

      function refreshTotal () {
        var el = document.getElementById("totalPoints");
        if (el) el.textContent = computeTotal();
      }

      // SUMMARY
      function updateSummary () {
        var container = document.getElementById("section-summary");
        if (!container) return;

        var html = '<div class="card"><h2>Summary</h2>';

        html += "<p>";
        html += "Base: " + fighter.points.base + " pts";
        html += " · Stats: " + fighter.points.stats + " pts";
        html += " · Warlock: " + fighter.points.warlock + " pts";
        html += " · CC Weapons: " + fighter.points.ccWeapons + " pts";
        html += " · Ranged Weapons: " + fighter.points.rangedWeapons + " pts";
        html += "<br>";
        html += "Abilities: " + fighter.points.abilities + " pts";
        html += " · Leader Abilities: " + fighter.points.leaderAbilities + " pts";
        html += " · Spells: " + fighter.points.spells + " pts";
        html += " · Equipment: " + fighter.points.equipment + " pts";
        html += "<br><span style='color:#3aa79f;'>Total: " + computeTotal() + " pts</span>";
        html += "</p>";


        // --- Snapshot (for screenshots) ---
        html += "<div class='summary-pill' style='margin-top:0.25rem;'>";
        html += "<div class='summary-category-title'>Snapshot</div>";
        html += "<div style='display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.35rem;'>";
        for (var si = 0; si < STAT_CONFIG.length; si++) {
          var scfg = STAT_CONFIG[si];
          var v = fighter.stats[scfg.key];
          html += "<div style='background:#141619;border:1px solid #2a2d31;border-radius:12px;padding:0.35rem 0.55rem;min-width:78px;text-align:center;'>";
          html += "<div style='font-size:0.72rem; letter-spacing:0.04em; text-transform:uppercase; color:#9aa1a8;'>" + scfg.label + "</div>";
          html += "<div style='font-weight:700; font-size:1.05rem; margin-top:0.05rem;'>" + v + (scfg.unit || "") + "</div>";
          html += "</div>";
        }
        html += "</div>";

        var wLabel = getWarlockLabel();
        html += "<div style='margin-top:0.6rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;'>";
        html += "<div style='background:#141619;border:1px solid #2a2d31;border-radius:12px;padding:0.35rem 0.55rem;min-width:160px;'>";
        html += "<div style='font-size:0.72rem; letter-spacing:0.04em; text-transform:uppercase; color:#9aa1a8;'>Warlock</div>";
        html += "<div style='font-weight:700; font-size:1.02rem; margin-top:0.05rem;'>" + wLabel + "</div>";
        html += "</div>";
        html += "</div>";

        html += "<div style='display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.6rem;'>";
        html += "<button class='tab-pill-colour' onclick='copyFighterText()'>Copy Text</button>";
        html += "<button class='tab-pill-colour' id='btn-portrait-secondary' onclick='openPortrait()' title='Crop / set portrait'>Portrait</button>";

        html += "<button class='tab-pill-colour' onclick='generateFighterCard()'>Generate Card</button>";
        html += "</div>";
        html += "<p style='margin:0.45rem 0 0; font-size:0.82rem; color:#9ca3af;'>Tip: use Copy Text for pasting the whole profile into a document or use Print Card to generate a simple Fighter Card. Use Portrait to upload, crop and insert an image of your Fighter into the card.</p>";
        html += "</div>";

        function renderList(title, arr) {
  html += '<div class="summary-pill">';
  html += '<div class="summary-category-title">' + title + '</div>';

  if (!arr || !arr.length) {
    html += "<p style='font-size:0.9rem; color:#9ca3af; margin:0;'>None</p>";
  } else {
    html += "<ul style='padding-left:1.1rem; margin:0; font-size:0.9rem;'>";
    for (var i = 0; i < arr.length; i++) {
      var x = arr[i];
      var main = (x.profile || x.effect || "").replace(/<br\s*\/?>/gi, "\n\n");
      var pts = x.points || 0;
      var meta = (title === "Spells")
        ? ("CV " + (x.cv != null ? x.cv : ""))
        : (pts + " pts");
      html += "<li style='margin-bottom:0.15rem;'>" +
              x.name + " (" + meta + ")" +
              (main ? " — " + main : "") +
              "</li>";
    }
    html += "</ul>";
  }

  html += "</div>";
}


        renderList("Close Combat Weapons", fighter.ccWeapons);
        renderList("Ranged Weapons",        fighter.rangedWeapons);
        renderList("Fighter Abilities",     fighter.abilities);
        renderList("Leader Abilities",      fighter.leaderAbilities);
        renderList("Spells",                fighter.spells);
        renderList("Equipment",             fighter.equipment);

        html += "</div>";
        container.innerHTML = html;
      }

      // STAT COST
      
      // ===== Copy / Print (snapshot) =====
      function getWarlockLabel () {
        return fighter.isMasterWarlock ? "Master Warlock" : (fighter.isWarlock ? "Warlock" : "None");
      }

      function buildCopyText () {
        var nm = (fighter.name && fighter.name.trim()) ? fighter.name.trim() : "Fighter";
        var lines = [];
        lines.push(nm + " — " + computeTotal() + " pts");
        lines.push("");

        // Stats
        var statBits = [];
        for (var i = 0; i < STAT_CONFIG.length; i++) {
          var sc = STAT_CONFIG[i];
          statBits.push(sc.label + " " + fighter.stats[sc.key] + (sc.unit || ""));
        }
        lines.push(statBits.join(" · "));
        lines.push("Warlock: " + getWarlockLabel());
        lines.push("");

        function cleanMultiline (s) {
          return String(s || "")
            // Convert any <br>, <br/>, <br />, or <br ...> variants into real line breaks
            .replace(/<br\s*\/?>/gi, "\n\n")
            .replace(/<br[^>]*>/gi, "\n\n")
            // Also catch slightly malformed variants like "<br<"
            .replace(/<br</gi, "\n\n")
            .replace(/\r\n/g, "\n")
            // Collapse excessive blank space
            .replace(/\n{3,}/g, "\n\n")
            .trim();
        }

        function listBlock (title, arr) {
          lines.push(title + ":");
          if (!arr || !arr.length) {
            lines.push("  - None");
            lines.push("");
            return;
          }

          for (var j = 0; j < arr.length; j++) {
            var x = arr[j];
            var pts = x.points || 0;
            lines.push("  - " + x.name + " (" + pts + " pts)");

            var main = cleanMultiline(x.profile || x.effect || "");
            if (main) {
              var bits = main.split(/\n+/);
              for (var bi = 0; bi < bits.length; bi++) {
                var line = bits[bi].trim();
                if (!line) continue;
                lines.push("      " + line);
              }
            }
          }
          lines.push("");
        }

        listBlock("Close Combat Weapons", fighter.ccWeapons);
        listBlock("Ranged Weapons", fighter.rangedWeapons);
        listBlock("Abilities", fighter.abilities);
        listBlock("Leader Abilities", fighter.leaderAbilities);
        listBlock("Spells", fighter.spells);
        listBlock("Equipment", fighter.equipment);

        return lines.join("\n");
      }

window.copyFighterText = function () {
  try {
    var txt = buildCopyText();

    // Convert HTML line breaks to real ones
    txt = txt.replace(/<br\s*\/?>/gi, "\n\n");

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(txt).then(function(){
        alert("Copied!");
      }).catch(function(){
        window.prompt("Copy this text:", txt);
      });
    } else {
      window.prompt("Copy this text:", txt);
    }
  } catch (e) {
    alert("Copy failed: " + e);
  }
};

      window.printFighterCard = function () {
        try {
          var nm = (fighter.name && fighter.name.trim()) ? fighter.name.trim() : "Fighter";
          var total = computeTotal();
          var warlockLabel = getWarlockLabel();

          function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

          function listHtml(title, arr) {
            var out = "<div class='block'><div class='block-title'>" + esc(title) + "</div>";
            if (!arr || !arr.length) return out + "<div class='muted'>None</div></div>";
            out += "<ul>";
            for (var i=0;i<arr.length;i++){
              var x=arr[i];
              var pts = x.points || 0;

              // Turn stored <br> tags (and any newlines) into real HTML line breaks on the printed card
              var mainRaw = (x.profile || x.effect || "");
              mainRaw = String(mainRaw).replace(/<br\s*\/?>/gi, "\n").replace(/\r\n/g, "\n");
              var rulesHtml = esc(mainRaw).replace(/\n+/g, "<br>");

              out += "<li><b>" + esc(getDisplayName(x)) + "</b> <span class='muted'>(" + pts + " pts)</span>";
              if (mainRaw) out += "<br><span class='muted'>" + rulesHtml + "</span>";
              out += "</li>";
            }
            out += "</ul></div>";
            return out;
          }var stats = "";
          for (var i=0;i<STAT_CONFIG.length;i++){
            var sc=STAT_CONFIG[i];
            stats += "<span class='stat'><span class='k'>" + esc(sc.label) + "</span> <span class='v'>" + esc(fighter.stats[sc.key] + (sc.unit||"")) + "</span></span>";
          }

          var w = window.open("", "_blank");
          if (!w) { alert("Popup blocked — allow popups to print the card."); return; }

          var doc = "";
          doc += "<!doctype html><html><head><meta charset='utf-8'><title>" + esc(nm) + " — " + total + " pts</title>";
          doc += "<style>";
          doc += "body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;color:#111;background:#fff;}";
          doc += ".card{border:2px solid #111;border-radius:14px;padding:16px;max-width:900px;}";
          doc += ".top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;}";
          doc += ".name{font-size:26px;font-weight:800;}";
          doc += ".pts{font-size:18px;font-weight:800;padding:6px 10px;border:2px solid #111;border-radius:12px;white-space:nowrap;}";
          doc += ".meta{margin-top:6px;font-size:13px;color:#333;}";
          doc += ".stats{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}";
          doc += ".stat{border:1px solid #111;border-radius:10px;padding:6px 8px;min-width:84px;text-align:center;}";
          doc += ".stat .k{display:block;font-size:11px;letter-spacing:.05em;text-transform:uppercase;color:#444;}";
          doc += ".stat .v{display:block;font-size:16px;font-weight:800;margin-top:2px;}";
          doc += ".grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}";
          doc += ".block{border:1px solid #111;border-radius:12px;padding:10px;}";
          doc += ".block-title{font-weight:900;margin-bottom:6px;}";
          doc += "ul{margin:0;padding-left:18px;}";
          doc += "li{margin-bottom:6px;}";
          doc += ".muted{color:#555;font-size:12px;}";
          doc += "@media print{body{margin:0} .card{border:none;border-radius:0}}";
          doc += "</style></head><body>";

          doc += "<div class='card'>";
          doc += "<div class='top'><div><div class='name'>" + esc(nm) + "</div></div><div class='pts'>" + total + " pts</div></div>";
          doc += "<div class='stats'>" + stats + "</div>";
          doc += "<div class='grid'>";
          doc += listHtml("Close Combat Weapons", fighter.ccWeapons);
          doc += listHtml("Ranged Weapons", fighter.rangedWeapons);
          doc += listHtml("Abilities", fighter.abilities);
          doc += listHtml("Leader Abilities", fighter.leaderAbilities);
          doc += listHtml("Spells", fighter.spells);
          doc += listHtml("Equipment", fighter.equipment);
          doc += "</div></div>";
          doc += "</body></html>";

          w.document.open();
          w.document.write(doc);
          w.document.close();

          setTimeout(function(){ try { w.focus(); w.print(); } catch(e){} }, 250);
        } catch (e) {
          alert("Print failed: " + e);
        }
      };


function recalcStatCost () {
        var total = 0;
        for (var i = 0; i < STAT_CONFIG.length; i++) {
          var cfg = STAT_CONFIG[i];
          var base = cfg.base;
          var cur = fighter.stats[cfg.key];
          if (cur === base) continue;
          var step = (cur > base) ? 1 : -1;
          var lowerIsBetter = !!cfg.lowerIsBetter;

          for (var v = base; v !== cur; v += step) {
            var next = v + step;
            var improving = lowerIsBetter ? (next < v) : (next > v);
            if (improving) {
              total += cfg.upCost || 0;
            } else {
              total -= cfg.downCost || 0;
            }
          }
        }
        fighter.points.stats = total;
      }

      // WARLOCK COST – 50% / 66% of (base + stat adjustments)
      function recalcWarlockCost () {
        var baseline = (fighter.points.base || 0) + (fighter.points.stats || 0);
        if (baseline < 0) {
          baseline = 0;
        }

        if (fighter.isMasterWarlock) {
          fighter.points.warlock = Math.ceil(baseline * 0.66);
        } else if (fighter.isWarlock) {
          fighter.points.warlock = Math.ceil(baseline * 0.5);
        } else {
          fighter.points.warlock = 0;
        }
      }

      // Build profile string with upgrades included
      function buildWeaponProfile (weapon) {
        var baseText = weapon.baseProfile || weapon.profile || "";
        var text = baseText;
        var extras = [];
        var up = weapon.upgrades || {};
        if (up.poison)        extras.push("Poison/Fire");
        if (up.enchanted)     extras.push("Crits on 9+");
        if (up.cursed)        extras.push("MW (2)");
        if (up.truestrike)        extras.push("Reroll (SR)");
        if (up.masterCrafted) extras.push("Piercing (-2)");

        if (extras.length) {
          if (text) {
            text += ", " + extras.join(", ");
          } else {
            text = extras.join(", ");
          }
        }
        weapon.profile = text; // keep summary in sync
        return text;
      }

                 // INIT STATS SECTION (with Warlock toggles + floating Total Points)
      function initStats () {
        var container = document.getElementById("section-stats");
        if (!container) return;

        var i, cfg;
        // Initialize stats to base values (only if missing)
        for (i = 0; i < STAT_CONFIG.length; i++) {
          cfg = STAT_CONFIG[i];
          if (fighter.stats[cfg.key] == null || isNaN(fighter.stats[cfg.key])) {
            fighter.stats[cfg.key] = cfg.base;
          }
        }

        var html = '<div class="card"><h2>Core Stats</h2>';

        // 🔹 Floating Total Points pill in the top-right of this card
        html += ''
          + '<div class="points-box-inline stats-total-floating">'
          + '  Total Points: <span id="totalPoints">0</span>'
          + '</div>';
        // Fighter name
        html += '<div style="margin-bottom:0.65rem; margin-top:0.15rem;">';
        html += '  <div style="font-size:0.75rem; text-transform:uppercase; color:#9aa1a8; margin-bottom:0.15rem;">Fighter Name</div>';
        html += '  <input id="fighter-name-input" type="text" placeholder="Enter name..." style="width:100%; padding:0.4rem 0.6rem; border-radius:8px; border:1px solid #2a2d31; background:#141619; color:#e5e7eb;">';
        html += '</div>';


        // Stat pills
        html += '<div class="stats-row">';
        for (i = 0; i < STAT_CONFIG.length; i++) {
          cfg = STAT_CONFIG[i];
          html += ''
            + '<div class="stat-pill" data-key="' + cfg.key + '">'
            + '  <div class="stat-pill-label">' + cfg.label + '</div>'
            + '  <div class="stat-pill-controls">'
            + '    <button class="stat-btn-vert stat-up">▲</button>'
            + '    <div class="stat-pill-value"><span class="value-text">' + (fighter.stats[cfg.key] != null ? fighter.stats[cfg.key] : cfg.base) + '</span>' + cfg.unit + '</div>'
            + '    <button class="stat-btn-vert stat-down">▼</button>'
            + '  </div>'
            + '</div>';
        }
        html += '</div>'; // end .stats-row

        // Warlock section
        html += ''
          + '<div class="warlock-box">'
          + '  <label class="warlock-option">'
          + '    <input type="checkbox" class="warlock-toggle" data-type="warlock"' + (fighter.isWarlock ? ' checked' : '') + '> Warlock (+50% of Stat cost)'
          + '  </label>'
          + '  <label class="warlock-option">'
          + '    <input type="checkbox" class="warlock-toggle" data-type="master"' + (fighter.isMasterWarlock ? ' checked' : '') + '> Master Warlock (+66% of Stat cost)'
          + '  </label>'
          + '  <div class="warlock-note">'
          + '    Warlocks gain access to spells. Only one of these options may be active.'
          + '  </div>'
          + '</div>';

        html += '</div>'; // end .card
        container.innerHTML = html;


        // Name input handler (idle/debounced to avoid heavy re-render while typing)
        var nameInput = document.getElementById("fighter-name-input");
        if (nameInput) {
          nameInput.value = fighter.name || "";
          var __nameTimer = null;
          var __idleHandle = null;
          function scheduleNameUpdate() {
            // cancel pending
            if (__nameTimer) { clearTimeout(__nameTimer); __nameTimer = null; }
            if (__idleHandle && window.cancelIdleCallback) { cancelIdleCallback(__idleHandle); __idleHandle = null; }

            var run = function () {
              __idleHandle = null;
              __nameTimer = null;
              updateSummary();
            };

            // Prefer idle callback so typing stays snappy on big builds
            if (window.requestIdleCallback) {
              __idleHandle = requestIdleCallback(run, { timeout: 600 });
            } else {
              __nameTimer = setTimeout(run, 250);
            }
          }

          nameInput.addEventListener("input", function () {
            fighter.name = this.value || "";
            scheduleNameUpdate();
          });

          // Force immediate update on blur / Enter
          nameInput.addEventListener("blur", function () {
            fighter.name = this.value || "";
            updateSummary();
          });
          nameInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
              fighter.name = this.value || "";
              updateSummary();
              this.blur();
            }
          });
        }

        // --- Stat pill handlers ---
        var pills = container.getElementsByClassName("stat-pill");

        function attachHandlers (pill) {
          var key = pill.getAttribute("data-key");
          var cfgLocal = null;
          for (var j = 0; j < STAT_CONFIG.length; j++) {
            if (STAT_CONFIG[j].key === key) {
              cfgLocal = STAT_CONFIG[j];
              break;
            }
          }
          if (!cfgLocal) return;

          var valueEl = pill.querySelector(".value-text");
          var upBtn = pill.querySelector(".stat-up");
          var downBtn = pill.querySelector(".stat-down");

          upBtn.addEventListener("click", function () {
            var val = fighter.stats[key];
            if (val < cfgLocal.max) {
              fighter.stats[key] = val + 1;
              valueEl.textContent = fighter.stats[key];
              recalcStatCost();
              recalcWarlockCost();
              recalcAbilityPoints(); // updates dynamic equipment
              refreshTotal();
              updateSummary();
            }
          });

          downBtn.addEventListener("click", function () {
            var val = fighter.stats[key];
            if (val > cfgLocal.min) {
              fighter.stats[key] = val - 1;
              valueEl.textContent = fighter.stats[key];
              recalcStatCost();
              recalcWarlockCost();
              recalcAbilityPoints(); // updates dynamic equipment
              refreshTotal();
              updateSummary();
            }
          });
        }

        for (var p = 0; p < pills.length; p++) {
          attachHandlers(pills[p]);
        }

        // --- Warlock toggles ---
        var warlockToggles = container.getElementsByClassName("warlock-toggle");

        function syncWarlock () {
          for (var w = 0; w < warlockToggles.length; w++) {
            var input = warlockToggles[w];
            var type = input.getAttribute("data-type");
            if (type === "warlock") {
              input.checked = !!fighter.isWarlock && !fighter.isMasterWarlock;
            } else {
              input.checked = !!fighter.isMasterWarlock;
            }
          }
        }

        for (var w2 = 0; w2 < warlockToggles.length; w2++) {
          (function (input) {
            input.addEventListener("change", function () {
              var type = input.getAttribute("data-type");
              if (type === "warlock") {
                fighter.isWarlock = input.checked;
                if (input.checked) fighter.isMasterWarlock = false;
              } else {
                fighter.isMasterWarlock = input.checked;
                if (input.checked) fighter.isWarlock = false;
              }
              recalcWarlockCost();
              recalcAbilityPoints(); // dynamic eq baseline
              syncWarlock();
              refreshTotal();
              updateSummary();
            });
          })(warlockToggles[w2]);
        }

        // Initial calculations
        recalcStatCost();
        recalcWarlockCost();
        recalcAbilityPoints();
        syncWarlock();
        refreshTotal();
        updateSummary();
      }



      // Compute upgrade cost for a single weapon
      function computeWeaponUpgradeCost (weapon) {
        if (!weapon.upgrades) return 0;
        var count = 0;
        if (weapon.upgrades.poison)        count++;
        if (weapon.upgrades.enchanted)     count++;
        if (weapon.upgrades.cursed)        count++;
        if (weapon.upgrades.truestrike)    count++;
        if (weapon.upgrades.masterCrafted) count++;
        if (count === 0) return 0;
        return 2 + (count - 1) * 4; // first = 2, others = 4
      }

      // WEAPON COST (base + upgrades)
      function recalcWeaponPoints () {
        var sumCC = 0;
        var sumR = 0;
        var i;

        for (i = 0; i < fighter.ccWeapons.length; i++) {
          var wc = fighter.ccWeapons[i];
          var base = (wc.basePoints != null) ? wc.basePoints : wc.points;
          var upgCost = computeWeaponUpgradeCost(wc);
          wc.points = base + upgCost;
          sumCC += wc.points;
        }

        for (i = 0; i < fighter.rangedWeapons.length; i++) {
          var rw = fighter.rangedWeapons[i];
          var baseR = (rw.basePoints != null) ? rw.basePoints : rw.points;
          var upgCostR = computeWeaponUpgradeCost(rw);
          rw.points = baseR + upgCostR;
          sumR += rw.points;
        }

        fighter.points.ccWeapons = sumCC;
        fighter.points.rangedWeapons = sumR;
      }

      // ABILITY / SPELL / EQUIPMENT COST
      // ABILITY / SPELL / EQUIPMENT COST
      function recalcAbilityPoints () {
        var i, sumA = 0, sumL = 0, sumS = 0, sumE = 0;

        // Fighter Abilities (some with dynamic HP-based cost)
        for (i = 0; i < fighter.abilities.length; i++) {
          var ab = fighter.abilities[i];
          var p = 0;

          if (ab.dynamicType === "percentHp") {
            var hp = fighter.stats.hp || 0;
            var factor = ab.dynamicFactor || 0;
            p = Math.ceil(hp * factor);
            ab.points = p; // keep stored value updated
          } else if (ab.dynamicType === "hpStat") {
            var hp2 = fighter.stats.hp || 0;
            var factor2 = (ab.dynamicFactor != null) ? ab.dynamicFactor : 1;
            p = Math.round(hp2 * factor2);
            ab.points = p;
          } else {
            p = ab.points || 0;
          }

          sumA += p;
        }

        // Leader Abilities (all 0)
        for (i = 0; i < fighter.leaderAbilities.length; i++) {
          sumL += fighter.leaderAbilities[i].points || 0;
        }

        // Spells (all 0)
        for (i = 0; i < fighter.spells.length; i++) {
          sumS += fighter.spells[i].points || 0;
        }

        // Equipment (with dynamic items)
        var baseline = (fighter.points.base || 0) + (fighter.points.stats || 0);
        if (baseline < 0) baseline = 0;

        for (i = 0; i < fighter.equipment.length; i++) {
          var eq = fighter.equipment[i];
          var ep = 0;
          if (eq.dynamicType === "percentStats") {
            var factorEq = eq.dynamicFactor || 0;
            ep = Math.ceil(baseline * factorEq);
            eq.points = ep;
          } else {
            ep = eq.points || 0;
          }
          sumE += ep;
        }

        fighter.points.abilities       = sumA;
        fighter.points.leaderAbilities = sumL;
        fighter.points.spells          = sumS;
        fighter.points.equipment       = sumE;

        // 🔑 Make sure the Selected lists show the updated point values
        refreshAbilityEquipmentDisplays();
      }

      // Update the displayed "X pts" labels in the Selected columns
      function refreshAbilityEquipmentDisplays () {
        // Fighter Abilities
        var abilList = document.getElementById("section-abilities-selected");
        if (abilList) {
          var rows = abilList.getElementsByClassName("item-row");
          for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var idxAttr = row.getAttribute("data-idx");
            var idx = idxAttr ? parseInt(idxAttr, 10) : i;
            var ab = fighter.abilities[idx];
            if (!ab) continue;
            var ptsEl = row.querySelector(".item-points");
            if (ptsEl) {
              ptsEl.textContent = (ab.points || 0) + " pts";
            }
          }
        }

        // Equipment
        var eqList = document.getElementById("section-equipment-selected");
        if (eqList) {
          var eqRows = eqList.getElementsByClassName("item-row");
          for (var j = 0; j < eqRows.length; j++) {
            var row2 = eqRows[j];
            var idxAttr2 = row2.getAttribute("data-idx");
            var idx2 = idxAttr2 ? parseInt(idxAttr2, 10) : j;
            var eq = fighter.equipment[idx2];
            if (!eq) continue;
            var ptsEl2 = row2.querySelector(".item-points");
            if (ptsEl2) {
              ptsEl2.textContent = (eq.points || 0) + " pts";
            }
          }
        }
      }



      // GENERIC PANEL FOR ABILITIES, LEADER, SPELLS, EQUIPMENT
      function initSimplePanel (sectionId, title, srcArray, targetArrayName, isSpell, maxSelect) {
        var container = document.getElementById(sectionId);
        if (!container) return;

        if (!fighter[targetArrayName]) {
          fighter[targetArrayName] = [];
        }

        var html = '<div class="card"><h2>' + title + '</h2>';
        if (isSpell) {
          html += "<p style='font-size:0.8rem; color:#9ca3af; margin-top:0; margin-bottom:0.5rem;'>Warlocks may choose 2 spells and use 1 per activation, Master Warlocks may choose 3 spells and use 2 per activation.</p>";
        }
        if (maxSelect && targetArrayName === "leaderAbilities") {
          html += "<p style='font-size:0.8rem; color:#9ca3af; margin-top:0; margin-bottom:0.5rem;'>You may select up to " + maxSelect + " Leader Abilities.</p>";
        }

        html += '<div class="flex-columns weapons-layout"><div class="column options-column">';
        html += '<h3>Options</h3><div class="item-list weapons-options-grid">';

        var i, it;
        for (i = 0; i < srcArray.length; i++) {
          it = srcArray[i];
          var rightLabel;
          if (isSpell) {
            rightLabel = "CV " + it.cv;
          } else {
            rightLabel = (it.points || 0) + " pts";
          }

          html += ''
            + '<div class="item-row" data-id="' + it.id + '">'
            + '  <div class="item-row-header">'
            + '    <div class="item-main">'
            + '      <div class="item-name">' + it.name + '</div>'
            + '      <div class="item-detail">' + (it.profile || it.effect || "") + '</div>'
            + '    </div>'
            + '    <div class="item-points">' + rightLabel + '</div>'
            + '  </div>'
            + '  <div class="item-footer">'
            + '    <div></div>'
            + '    <div class="item-actions"><button class="add-btn">Add</button></div>'
            + '  </div>'
            + '</div>';
        }

        html += '</div></div>';
        html += '<div class="column selected-column">';
        html += '<h3>Selected</h3><div class="item-list" id="' + sectionId + '-selected"></div>';
        html += '</div></div>';
        html += '</div>';
        container.innerHTML = html;

        function renderSelected () {
          var listEl = document.getElementById(sectionId + "-selected");
          var arr = fighter[targetArrayName];
          var i;
          if (!arr || !arr.length) {
            listEl.innerHTML = "<p style='font-size:0.9rem; color:#9ca3af;'>None</p>";
            return;
          }
          var sHtml = "";
          for (i = 0; i < arr.length; i++) {
            var a = arr[i];
            var rightLabel;
            if (isSpell) {
              rightLabel = "CV " + (a.cv != null ? a.cv : "?");
            } else {
              rightLabel = (a.points || 0) + " pts";
            }

            sHtml += ''
              + '<div class="item-row" data-idx="' + i + '">'
              + '  <div class="item-row-header">'
              + '    <div class="item-main">'
              + '      <div class="item-name">' + a.name + '</div>'
              + '      <div class="item-detail">' + (a.profile || a.effect || "") + '</div>'
              + '    </div>'
              + '    <div class="item-points">' + rightLabel + '</div>'
              + '  </div>'
              + '  <div class="item-footer">'
              + '    <div></div>'
              + '    <div class="item-actions"><button class="rename-btn">Rename</button><button class="remove-btn">Remove</button></div>'
              + '  </div>'
              + '</div>';
          }
          listEl.innerHTML = sHtml;

          var removes = listEl.getElementsByClassName("remove-btn");
          for (i = 0; i < removes.length; i++) {
            (function (btn) {
              btn.addEventListener("click", function () {
                var row = btn.closest(".item-row");
                var idx = parseInt(row.getAttribute("data-idx"), 10);
                fighter[targetArrayName].splice(idx, 1);
                recalcAbilityPoints();
                refreshTotal();
                updateSummary();
                renderSelected();
              });
            })(removes[i]);
          }


var renames = listEl.getElementsByClassName("rename-btn");
for (i = 0; i < renames.length; i++) {
  (function (btn) {
    btn.addEventListener("click", function () {
      var row = btn.closest(".item-row");
      var idx = parseInt(row.getAttribute("data-idx"), 10);
      var it = fighter[targetArrayName][idx];
      if (promptRename(it)) {
        refreshTotal();
        updateSummary();
        renderSelected();
      }
    });
  })(renames[i]);
}
        }

        var adds = container.getElementsByClassName("add-btn");
        for (var j = 0; j < adds.length; j++) {
          (function (btn) {
            btn.addEventListener("click", function () {
              var row = btn.closest(".item-row");
              var id = row.getAttribute("data-id");
              var src = srcArray;
              var found = null;
              var k;
              for (k = 0; k < src.length; k++) {
                if (src[k].id === id) {
                  found = src[k];
                  break;
                }
              }
              if (!found) return;

              if (isSpell && !fighter.isWarlock && !fighter.isMasterWarlock) {
                alert("You must be a Warlock or Master Warlock to add spells.");
                return;
              }

              if (maxSelect && fighter[targetArrayName].length >= maxSelect) {
                alert("You may only select up to " + maxSelect + " " + title + ".");
                return;
              }

              fighter[targetArrayName].push({
                name: found.name,
                points: (isSpell ? 0 : (found.points || 0)),
                profile: found.profile,
                effect: found.effect,
                dynamicType: found.dynamicType,
                dynamicFactor: found.dynamicFactor,
                cv: found.cv
              });
              recalcAbilityPoints();
              refreshTotal();
              updateSummary();
              renderSelected();
            });
          })(adds[j]);
        }

        recalcAbilityPoints();
        renderSelected();
        refreshTotal();
        updateSummary();
      }

      // CC WEAPONS PANEL
      function initWeaponsCC () {
        var container = document.getElementById("section-weapons-cc");
        if (!container) return;

        var html = '<div class="card"><h2>Close Combat Weapons</h2>';
        html += '<div class="flex-columns weapons-layout">';

        html += '<div class="column options-column"><h3>Options</h3><div class="item-list weapons-options-grid">';
        var i, w;
        for (i = 0; i < CC_WEAPONS.length; i++) {
          w = CC_WEAPONS[i];
          html += ''
            + '<div class="item-row" data-group="cc" data-id="' + w.id + '">'
            + '  <div class="item-row-header">'
            + '    <div class="item-main">'
            + '      <div class="item-name">' + w.name + '</div>'
            + '      <div class="item-detail">' + w.profile + '</div>'
            + '    </div>'
            + '    <div class="item-points">' + w.points + ' pts</div>'
            + '  </div>'
            + '  <div class="item-footer">'
            + '    <div></div>'
            + '    <div class="item-actions"><button class="add-weapon">Add</button></div>'
            + '  </div>'
            + '</div>';
        }
        html += '</div></div>';

        html += '<div class="column selected-column"><h3>Selected CC Weapons</h3><div id="ccSelected" class="item-list"></div></div>';

        html += '</div></div>';
        container.innerHTML = html;

        function renderSelected () {
          var ccEl = document.getElementById("ccSelected");
          var i;

          if (!fighter.ccWeapons.length) {
            ccEl.innerHTML = '<p style="font-size:0.9rem; color:#9ca3af;">None</p>';
          } else {
            var ccHtml = "";
            for (i = 0; i < fighter.ccWeapons.length; i++) {
              var wc = fighter.ccWeapons[i];
              var prof = buildWeaponProfile(wc);
              ccHtml += ''
                + '<div class="item-row" data-idx="' + i + '" data-group="cc">'
                + '  <div class="item-row-header">'
                + '    <div class="item-main">'
                + '      <div class="item-name">' + wc.name + '</div>'
                + '      <div class="item-detail">' + prof + '</div>'
                + '    </div>'
                + '    <div class="item-points">' + wc.points + ' pts</div>'
                + '  </div>'
                + '  <div class="weapon-upgrades">'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="poison"' + (wc.upgrades && wc.upgrades.poison ? ' checked' : '') + '>Poisoned/Fiery</label>'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="enchanted"' + (wc.upgrades && wc.upgrades.enchanted ? ' checked' : '') + '>Enchanted</label>'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="cursed"' + (wc.upgrades && wc.upgrades.cursed ? ' checked' : '') + '>Cursed</label>'
                  + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="truestrike"' + (wc.upgrades && wc.upgrades.truestrike ? ' checked' : '') + '>Truestrike</label>'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="masterCrafted"' + (wc.upgrades && wc.upgrades.masterCrafted ? ' checked' : '') + '>Master Crafted</label>'
                + '  </div>'
                + '  <div class="item-footer">'
                + '    <div></div>'
                + '    <div class="item-actions"><button class="rename-btn" data-type="cc">Rename</button><button class="remove-btn" data-type="cc">Remove</button></div>'
                + '  </div>'
                + '</div>';
            }
            ccEl.innerHTML = ccHtml;
          }

          var removes = container.getElementsByClassName("remove-btn");
          for (i = 0; i < removes.length; i++) {
            (function (btn) {
              btn.addEventListener("click", function () {
                var row = btn.closest(".item-row");
                var idx = parseInt(row.getAttribute("data-idx"), 10);
                fighter.ccWeapons.splice(idx, 1);
                recalcWeaponPoints();
                refreshTotal();
                updateSummary();
                renderSelected();
              });
            })(removes[i]);
          }


var renames = container.getElementsByClassName("rename-btn");
for (i = 0; i < renames.length; i++) {
  (function (btn) {
    btn.addEventListener("click", function () {
      var row = btn.closest(".item-row");
      var idx = parseInt(row.getAttribute("data-idx"), 10);
      var grp = row.getAttribute("data-group") || btn.getAttribute("data-type");
      var arr = (grp === "ranged" ? fighter.rangedWeapons : fighter.ccWeapons);
      var it = arr[idx];
      if (promptRename(it)) {
        refreshTotal();
        updateSummary();
        renderSelected();
      }
    });
  })(renames[i]);
}

          var upgToggles = container.getElementsByClassName("upgrade-toggle");
          for (i = 0; i < upgToggles.length; i++) {
            (function (input) {
              input.addEventListener("change", function () {
                var row = input.closest(".item-row");
                var idx = parseInt(row.getAttribute("data-idx"), 10);
                var upgKey = input.getAttribute("data-upg");

                var arr = fighter.ccWeapons;
                var wObj = arr[idx];
                if (!wObj.upgrades) {
                  wObj.upgrades = { poison: false, enchanted: false, cursed: false, truestrike: false, masterCrafted: false };
                }
                wObj.upgrades[upgKey] = input.checked;

                recalcWeaponPoints();
                renderSelected();
                refreshTotal();
                updateSummary();
              });
            })(upgToggles[i]);
          }
        }

        var adds = container.getElementsByClassName("add-weapon");
        for (var k = 0; k < adds.length; k++) {
          (function (btn) {
            btn.addEventListener("click", function () {
              var row = btn.closest(".item-row");
              var id = row.getAttribute("data-id");
              var srcArray = CC_WEAPONS;
              var i, found = null;
              for (i = 0; i < srcArray.length; i++) {
                if (srcArray[i].id === id) {
                  found = srcArray[i];
                  break;
                }
              }
              if (!found) return;

              fighter.ccWeapons.push({
                name: found.name,
                baseProfile: found.profile,
                profile: found.profile,
                basePoints: found.points,
                points: found.points,
                upgrades: {
                  poison: false,
                  enchanted: false,
                  cursed: false,
                  truestrike: false,  
                  masterCrafted: false
                }
              });
              recalcWeaponPoints();
              refreshTotal();
              updateSummary();
              renderSelected();
            });
          })(adds[k]);
        }

        recalcWeaponPoints();
        renderSelected();
        refreshTotal();
        updateSummary();
      }

      // RANGED WEAPONS PANEL
      function initWeaponsRanged () {
        var container = document.getElementById("section-weapons-ranged");
        if (!container) return;

        var html = '<div class="card"><h2>Ranged Weapons</h2>';
        html += '<div class="flex-columns weapons-layout">';

        html += '<div class="column options-column"><h3>Options</h3><div class="item-list weapons-options-grid">';
        var i, r;
        for (i = 0; i < RANGED_WEAPONS.length; i++) {
          r = RANGED_WEAPONS[i];
          html += ''
            + '<div class="item-row" data-group="ranged" data-id="' + r.id + '">'
            + '  <div class="item-row-header">'
            + '    <div class="item-main">'
            + '      <div class="item-name">' + r.name + '</div>'
            + '      <div class="item-detail">' + r.profile + '</div>'
            + '    </div>'
            + '    <div class="item-points">' + r.points + ' pts</div>'
            + '  </div>'
            + '  <div class="item-footer">'
            + '    <div></div>'
            + '    <div class="item-actions"><button class="add-weapon">Add</button></div>'
            + '  </div>'
            + '</div>';
        }
        html += '</div></div>';

        html += '<div class="column selected-column"><h3>Selected Ranged Weapons</h3><div id="rangedSelected" class="item-list"></div></div>';

        html += '</div></div>';
        container.innerHTML = html;

        function renderSelected () {
          var rEl = document.getElementById("rangedSelected");
          var i;

          if (!fighter.rangedWeapons.length) {
            rEl.innerHTML = '<p style="font-size:0.9rem; color:#9ca3af;">None</p>';
          } else {
            var rHtml = "";
            for (i = 0; i < fighter.rangedWeapons.length; i++) {
              var rw = fighter.rangedWeapons[i];
              var profR = buildWeaponProfile(rw);
              rHtml += ''
                + '<div class="item-row" data-idx="' + i + '" data-group="ranged">'
                + '  <div class="item-row-header">'
                + '    <div class="item-main">'
                + '      <div class="item-name">' + rw.name + '</div>'
                + '      <div class="item-detail">' + profR + '</div>'
                + '    </div>'
                + '    <div class="item-points">' + rw.points + ' pts</div>'
                + '  </div>'
                + '  <div class="weapon-upgrades">'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="poison"' + (rw.upgrades && rw.upgrades.poison ? ' checked' : '') + '>Poisoned/Fiery</label>'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="enchanted"' + (rw.upgrades && rw.upgrades.enchanted ? ' checked' : '') + '>Enchanted</label>'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="cursed"' + (rw.upgrades && rw.upgrades.cursed ? ' checked' : '') + '>Cursed</label>'
                   + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="truestrike"' + (rw.upgrades && rw.upgrades.truestrike ? ' checked' : '') + '>Truestrike</label>'
                + '    <label><input type="checkbox" class="upgrade-toggle" data-upg="masterCrafted"' + (rw.upgrades && rw.upgrades.masterCrafted ? ' checked' : '') + '>Master Crafted</label>'
                + '  </div>'
                + '  <div class="item-footer">'
                + '    <div></div>'
                + '    <div class="item-actions"><button class="rename-btn" data-type="ranged">Rename</button><button class="remove-btn" data-type="ranged">Remove</button></div>'
                + '  </div>'
                + '</div>';
            }
            rEl.innerHTML = rHtml;
          }

          var removes = container.getElementsByClassName("remove-btn");
          for (i = 0; i < removes.length; i++) {
            (function (btn) {
              btn.addEventListener("click", function () {
                var row = btn.closest(".item-row");
                var idx = parseInt(row.getAttribute("data-idx"), 10);
                fighter.rangedWeapons.splice(idx, 1);
                recalcWeaponPoints();
                refreshTotal();
                updateSummary();
                renderSelected();
              });
            })(removes[i]);
          }

          

          var renames = container.getElementsByClassName("rename-btn");
          for (i = 0; i < renames.length; i++) {
            (function (btn) {
              btn.addEventListener("click", function () {
                var row = btn.closest(".item-row");
                var idx = parseInt(row.getAttribute("data-idx"), 10);
                var arr = fighter.rangedWeapons;
                var it = arr[idx];
                if (promptRename(it)) {
                  refreshTotal();
                  updateSummary();
                  renderSelected();
                }
              });
            })(renames[i]);
          }

var upgToggles = container.getElementsByClassName("upgrade-toggle");
          for (i = 0; i < upgToggles.length; i++) {
            (function (input) {
              input.addEventListener("change", function () {
                var row = input.closest(".item-row");
                var idx = parseInt(row.getAttribute("data-idx"), 10);
                var upgKey = input.getAttribute("data-upg");

                var arr = fighter.rangedWeapons;
                var wObj = arr[idx];
                if (!wObj.upgrades) {
                  wObj.upgrades = { poison: false, enchanted: false, cursed: false, truestrike: false, masterCrafted: false };
                }
                wObj.upgrades[upgKey] = input.checked;

                recalcWeaponPoints();
                renderSelected();
                refreshTotal();
                updateSummary();
              });
            })(upgToggles[i]);
          }
        }

        var adds = container.getElementsByClassName("add-weapon");
        for (var k = 0; k < adds.length; k++) {
          (function (btn) {
            btn.addEventListener("click", function () {
              var row = btn.closest(".item-row");
              var id = row.getAttribute("data-id");
              var srcArray = RANGED_WEAPONS;
              var i, found = null;
              for (i = 0; i < srcArray.length; i++) {
                if (srcArray[i].id === id) {
                  found = srcArray[i];
                  break;
                }
              }
              if (!found) return;

              fighter.rangedWeapons.push({
                name: found.name,
                baseProfile: found.profile,
                profile: found.profile,
                basePoints: found.points,
                points: found.points,
                upgrades: {
                  poison: false,
                  enchanted: false,
                  cursed: false,
                  truestrike: false,
                  masterCrafted: false
                }
              });
              recalcWeaponPoints();
              refreshTotal();
              updateSummary();
              renderSelected();
            });
          })(adds[k]);
        }

        recalcWeaponPoints();
        renderSelected();
        refreshTotal();
        updateSummary();
      }

      // TABS
      function initTabs () {
        var tabsContainer = document.getElementById("section-tabs");
        if (!tabsContainer) return;

        var tabs = tabsContainer.getElementsByClassName("tab-pill");
        var sectionIds = [
          "section-weapons-cc",
          "section-weapons-ranged",
          "section-abilities",
          "section-leader",
          "section-spells",
          "section-equipment",
          "section-summary"
        ];

        function setActiveTab (targetId) {
          var i;
          for (i = 0; i < tabs.length; i++) {
            var tab = tabs[i];
            var tTarget = tab.getAttribute("data-target");
            if (tTarget === targetId) {
              tab.classList.add("active");
            } else {
              tab.classList.remove("active");
            }
          }
          for (i = 0; i < sectionIds.length; i++) {
            var secId = sectionIds[i];
            var el = document.getElementById(secId);
            if (!el) continue;
            el.style.display = (secId === targetId) ? "block" : "none";
          }
        }

        for (var j = 0; j < tabs.length; j++) {
          (function (tab) {
            tab.addEventListener("click", function () {
              var target = tab.getAttribute("data-target");
              setActiveTab(target);
            });
          })(tabs[j]);
        }

        setActiveTab("section-weapons-cc");
      }

      
      // ================= JSON Save/Load + Autosave =================
      function deepClone(obj){
        try { return JSON.parse(JSON.stringify(obj)); }
        catch(e){ return null; }
      }

      function buildExportPayload(){
        // Ensure all derived values are up to date before exporting
        try{
          recalcStatCost();
          recalcWarlockCost();
          recalcWeaponPoints();
          recalcAbilityPoints();
        }catch(e){}
        return {
          app: "Dark Realms Fighter Builder",
          version: 1,
          savedAt: new Date().toISOString(),
          fighter: deepClone(fighter)
        };
      }

      function downloadJson(filename, dataObj){
        var jsonStr = JSON.stringify(dataObj, null, 2);
        var blob = new Blob([jsonStr], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){
          try{ URL.revokeObjectURL(url); }catch(e){}
          try{ document.body.removeChild(a); }catch(e){}
        }, 0);
      }

      function safeAssign(target, src){
        if (!src || typeof src !== "object") return;
        Object.keys(src).forEach(function(k){ target[k] = src[k]; });
      }

      function applyImportedFighterState(imported){
        if (!imported || typeof imported !== "object") throw new Error("Invalid JSON (no fighter object).");

        // Replace top-level scalar/flags
        fighter.name = imported.name || "";
        fighter.isWarlock = !!imported.isWarlock;
        fighter.isMasterWarlock = !!imported.isMasterWarlock;

        // Portrait (optional)
        fighter.portraitDataUrl = (typeof imported.portraitDataUrl === "string") ? imported.portraitDataUrl : (fighter.portraitDataUrl || "");

        // Stats
        if (!fighter.stats) fighter.stats = {};
        safeAssign(fighter.stats, imported.stats || {});

        // Lists (replace arrays)
        fighter.ccWeapons = Array.isArray(imported.ccWeapons) ? imported.ccWeapons : [];
        fighter.rangedWeapons = Array.isArray(imported.rangedWeapons) ? imported.rangedWeapons : [];
        fighter.abilities = Array.isArray(imported.abilities) ? imported.abilities : [];
        fighter.leaderAbilities = Array.isArray(imported.leaderAbilities) ? imported.leaderAbilities : [];
        fighter.spells = Array.isArray(imported.spells) ? imported.spells : [];
        fighter.equipment = Array.isArray(imported.equipment) ? imported.equipment : [];

        // Points block: keep base if present, otherwise default
        if (!fighter.points) fighter.points = {};
        var baseDefault = 16;
        fighter.points.base = (imported.points && typeof imported.points.base === "number") ? imported.points.base : (fighter.points.base || baseDefault);

        // Recompute all derived points and refresh UI
        recalcStatCost();
        recalcWarlockCost();
        recalcWeaponPoints();
        recalcAbilityPoints();

        // Re-render all panels to ensure checkboxes + selected lists match
        initStats();
        initWeaponsCC();
        initWeaponsRanged();
        initSimplePanel("section-abilities", "Fighter Abilities", FIGHTER_ABILITIES, "abilities", false, null);
        initSimplePanel("section-leader",   "Leader Abilities",  LEADER_ABILITIES,  "leaderAbilities", false, 2);
        initSimplePanel("section-spells",   "Spells",            SPELLS,            "spells", true, null);
        initSimplePanel("section-equipment","Equipment",         EQUIPMENT,         "equipment", false, null);

        refreshTotal();
        updateSummary();
        try{ initTabs(); }catch(e){}
      }

      function importFromJsonText(jsonText){
        var parsed;
        try { parsed = JSON.parse(jsonText); } catch(e){ throw new Error("Invalid JSON."); }

        // Accept either {fighter:{...}} payloads or plain fighter objects
        var f = parsed && parsed.fighter ? parsed.fighter : parsed;
        applyImportedFighterState(f);
      }
      function setupJsonUi(){
        var btnSave = document.getElementById("btn-save-json");
        var inputLoad = document.getElementById("file-load-json");
if (btnSave){
          btnSave.addEventListener("click", function(){
            var payload = buildExportPayload();
            var nm = (fighter.name && fighter.name.trim()) ? fighter.name.trim() : "fighter";
            var safe = nm.replace(/[^\w\-]+/g, "_").slice(0, 50) || "fighter";
            downloadJson("darkrealms_" + safe + ".json", payload);
          });
        }

        if (inputLoad){
          inputLoad.addEventListener("change", function(){
            var file = this.files && this.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(){
              try{
                importFromJsonText(String(reader.result || ""));
                alert("Loaded!");
              }catch(e){
                alert("Load failed: " + e.message);
              }
              inputLoad.value = ""; // reset so re-loading same file triggers change
            };
            reader.onerror = function(){ alert("Load failed: could not read file."); inputLoad.value = ""; };
            reader.readAsText(file);
          });
        }
      }


      // INIT
      

      // ================= Portrait Cropper (Integrated) =================
      (function(){
        var btnPortrait = null;
        var ov = null;
        var fileEl = null, badgeEl = null, warnEl = null;
        var cvs = null, ctx = null;

        // Locked output size (must match your standalone cropper)
        var OUT_W = 682, OUT_H = 592;
        var TRI_BORDER_COLOR = "#D8E2D7";
        var TRI_BORDER_WIDTH = 8;

        // state
        var img = null;
        var imgReady = false;
        var offsetX = 0, offsetY = 0, scale = 1;
        var dragging = false, lastX = 0, lastY = 0;

        var pointers = new Map();
        var pinchStartDist = 0, pinchStartScale = 1;
        var pinchMid = {x:0,y:0};
        var pinchStartOffset = {x:0,y:0};

        function setWarn(msg){
          if (!warnEl) return;
          if (!msg){
            warnEl.style.display = "none";
            warnEl.textContent = "";
            return;
          }
          warnEl.textContent = msg;
          warnEl.style.display = "block";
        }

        function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

        function trianglePath(w,h){
          // Locked: pointing down
          return [[0,0],[w,0],[w/2,h]];
        }

        function setCanvasSizeLocked(){
          if (!cvs) return;
          cvs.width = OUT_W;
          cvs.height = OUT_H;
        }

        function canvasPointFromEvent(e){
          var r = cvs.getBoundingClientRect();
          var x = (e.clientX - r.left) * (cvs.width / r.width);
          var y = (e.clientY - r.top)  * (cvs.height / r.height);
          return {x:x,y:y};
        }

        function zoomAtCanvasPoint(factor, p){
          var oldScale = scale;
          var newScale = clamp(scale * factor, 0.05, 20);
          if (newScale === oldScale) return;

          var W = cvs.width, H = cvs.height;
          var cx = W/2 + offsetX;
          var cy = H/2 + offsetY;

          var dx = p.x - cx;
          var dy = p.y - cy;

          var ratio = newScale / oldScale;
          offsetX -= dx * (ratio - 1);
          offsetY -= dy * (ratio - 1);

          scale = newScale;
          draw();
        }

        function resetView(){
          offsetX = 0; offsetY = 0; scale = 1;
          draw();
        }

        function fitToTriangle(){
          if (!imgReady) return;
          var W = cvs.width, H = cvs.height;
          var iw = img.naturalWidth || img.width;
          var ih = img.naturalHeight || img.height;

          // cover the whole output frame
          scale = Math.max(W/iw, H/ih);
          offsetX = 0; offsetY = 0;
          draw();
        }

        function draw(){
          if (!ctx) return;
          var W = cvs.width, H = cvs.height;
          ctx.clearRect(0,0,W,H);

          // Triangle clip
          var pts = trianglePath(W,H);
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(pts[0][0], pts[0][1]);
          ctx.lineTo(pts[1][0], pts[1][1]);
          ctx.lineTo(pts[2][0], pts[2][1]);
          ctx.closePath();
          ctx.clip();

          if (imgReady){
            var iw = img.naturalWidth || img.width;
            var ih = img.naturalHeight || img.height;
            var dw = iw * scale;
            var dh = ih * scale;
            var x = (W/2 - dw/2) + offsetX;
            var y = (H/2 - dh/2) + offsetY;
            ctx.drawImage(img, x, y, dw, dh);

            // border (inside clip so it never bleeds outside)
            ctx.lineWidth = TRI_BORDER_WIDTH;
            ctx.strokeStyle = TRI_BORDER_COLOR;
            ctx.beginPath();
            ctx.moveTo(pts[0][0], pts[0][1]);
            ctx.lineTo(pts[1][0], pts[1][1]);
            ctx.lineTo(pts[2][0], pts[2][1]);
            ctx.closePath();
            ctx.stroke();
          } else {
            ctx.save();
            ctx.fillStyle = "rgba(255,255,255,.08)";
            ctx.fillRect(0,0,W,H);
            ctx.restore();
          }

          ctx.restore();

          // Preview-only: darken outside triangle for clarity
          ctx.save();
          ctx.fillStyle = "rgba(0,0,0,.35)";
          ctx.beginPath();
          ctx.rect(0,0,W,H);
          ctx.moveTo(pts[0][0], pts[0][1]);
          ctx.lineTo(pts[1][0], pts[1][1]);
          ctx.lineTo(pts[2][0], pts[2][1]);
          ctx.closePath();
          ctx.fill("evenodd");
          ctx.restore();
        }

        function exportTrianglePNG(){
          var W = OUT_W, H = OUT_H;
          var off = document.createElement("canvas");
          off.width = W; off.height = H;
          var octx = off.getContext("2d", {alpha:true});

          var pts = trianglePath(W,H);
          octx.save();
          octx.beginPath();
          octx.moveTo(pts[0][0], pts[0][1]);
          octx.lineTo(pts[1][0], pts[1][1]);
          octx.lineTo(pts[2][0], pts[2][1]);
          octx.closePath();
          octx.clip();

          var iw = img.naturalWidth || img.width;
          var ih = img.naturalHeight || img.height;
          var dw = iw * scale;
          var dh = ih * scale;
          var x = (W/2 - dw/2) + offsetX;
          var y = (H/2 - dh/2) + offsetY;

          octx.drawImage(img, x, y, dw, dh);

          // baked border
          octx.lineWidth = TRI_BORDER_WIDTH;
          octx.strokeStyle = TRI_BORDER_COLOR;
          octx.beginPath();
          octx.moveTo(pts[0][0], pts[0][1]);
          octx.lineTo(pts[1][0], pts[1][1]);
          octx.lineTo(pts[2][0], pts[2][1]);
          octx.closePath();
          octx.stroke();

          octx.restore();
          return off.toDataURL("image/png");
        }

        function updatePortraitButton(){
          var has = (fighter && fighter.portraitDataUrl && String(fighter.portraitDataUrl).trim());
          var label = has ? "Portrait ✓" : "Portrait";
          if (btnPortrait) btnPortrait.textContent = label;
          var secondary = document.getElementById("btn-portrait-secondary");
          if (secondary) secondary.textContent = label;
        }

        function openPortrait(){
          if (!ov) return;
          setWarn(null);
          ov.classList.add("show");
          ov.setAttribute("aria-hidden","false");
          document.body.style.overflow = "hidden";

          // init canvas
          setCanvasSizeLocked();
          ctx = cvs.getContext("2d", { alpha:true });

          // show badge
          if (badgeEl) badgeEl.textContent = (imgReady ? "Loaded" : "No image loaded") + " • " + OUT_W + "×" + OUT_H;

          // If we already have a portrait, keep it; otherwise just draw placeholder.
          draw();
        }

        // Expose for inline button in the summary panel
        window.openPortrait = openPortrait;


        function closePortrait(){
          if (!ov) return;
          ov.classList.remove("show");
          ov.setAttribute("aria-hidden","true");
          document.body.style.overflow = "";
          updatePortraitButton();
        }

        function wire(){
          btnPortrait = document.getElementById("btn-portrait");
          ov = document.getElementById("portrait-cropper-overlay");
          fileEl = document.getElementById("pc-file");
          badgeEl = document.getElementById("pc-badge");
          warnEl = document.getElementById("pc-warn");
          cvs = document.getElementById("pc-canvas");
          if (!btnPortrait || !ov || !fileEl || !cvs) return;

          // open/close
          btnPortrait.addEventListener("click", function(){ openPortrait(); });
          document.getElementById("pc-close").addEventListener("click", function(){ closePortrait(); });
          ov.addEventListener("click", function(e){
            if (e.target === ov) closePortrait();
          });

          // buttons
          document.getElementById("pc-fit").addEventListener("click", function(){ setWarn(null); fitToTriangle(); });
          document.getElementById("pc-reset").addEventListener("click", function(){ setWarn(null); resetView(); });

          document.getElementById("pc-use").addEventListener("click", function(){
            setWarn(null);
            if (!imgReady){
              setWarn("Load an image first.");
              return;
            }
            try{
              fighter.portraitDataUrl = exportTrianglePNG();
updateSummary();
              refreshTotal();
              closePortrait();
            }catch(err){
              setWarn("Could not export the portrait. Try a different image file.");
            }
          });

          // image load
          fileEl.addEventListener("change", function(e){
            var f = e.target.files && e.target.files[0];
            if (!f) return;
            setWarn(null);
            if (badgeEl) badgeEl.textContent = "Loading…";

            var url = URL.createObjectURL(f);
            var im = new Image();
            im.onload = function(){
              img = im;
              imgReady = true;
              if (badgeEl) badgeEl.textContent = "Loaded • " + OUT_W + "×" + OUT_H;
              fitToTriangle();
              try{ URL.revokeObjectURL(url); }catch(_){}
            };
            im.onerror = function(){
              imgReady = false;
              if (badgeEl) badgeEl.textContent = "Failed to load image • " + OUT_W + "×" + OUT_H;
              setWarn("Could not load that image. Try a JPG or PNG.");
              try{ URL.revokeObjectURL(url); }catch(_){}
              draw();
            };
            im.src = url;
          });

          // pointer / wheel controls
          cvs.addEventListener("pointerdown", function(e){
            cvs.setPointerCapture(e.pointerId);
            pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

            if (pointers.size === 1){
              dragging = true;
              lastX = e.clientX;
              lastY = e.clientY;
            } else if (pointers.size === 2){
              var pts = Array.from(pointers.values());
              pinchStartDist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
              pinchStartScale = scale;
              pinchStartOffset = {x: offsetX, y: offsetY};

              var midClient = {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2};
              var r = cvs.getBoundingClientRect();
              pinchMid = {
                x: (midClient.x - r.left) * (cvs.width / r.width),
                y: (midClient.y - r.top)  * (cvs.height / r.height)
              };
            }
          });

          cvs.addEventListener("pointermove", function(e){
            if (!pointers.has(e.pointerId)) return;
            pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

            if (pointers.size === 1 && dragging){
              var dx = e.clientX - lastX;
              var dy = e.clientY - lastY;
              lastX = e.clientX;
              lastY = e.clientY;

              var r = cvs.getBoundingClientRect();
              offsetX += dx * (cvs.width / r.width);
              offsetY += dy * (cvs.height / r.height);
              draw();
            } else if (pointers.size === 2){
              var pts = Array.from(pointers.values());
              var dist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
              if (pinchStartDist > 0){
                var factor = dist / pinchStartDist;
                scale = clamp(pinchStartScale * factor, 0.05, 20);

                var ratio = scale / pinchStartScale;
                var W = cvs.width, H = cvs.height;
                var cx0 = W/2 + pinchStartOffset.x;
                var cy0 = H/2 + pinchStartOffset.y;
                var dx = pinchMid.x - cx0;
                var dy = pinchMid.y - cy0;

                offsetX = pinchStartOffset.x - dx * (ratio - 1);
                offsetY = pinchStartOffset.y - dy * (ratio - 1);
                draw();
              }
            }
          });

          cvs.addEventListener("pointerup", function(e){
            pointers.delete(e.pointerId);
            dragging = false;
            if (pointers.size === 1){
              var remaining = Array.from(pointers.values())[0];
              lastX = remaining.x; lastY = remaining.y;
              dragging = true;
            }
          });

          cvs.addEventListener("pointercancel", function(e){
            pointers.delete(e.pointerId);
            dragging = false;
          });

          cvs.addEventListener("wheel", function(e){
            e.preventDefault();
            if (!imgReady) return;
            var p = canvasPointFromEvent(e);
            var direction = Math.sign(e.deltaY);
            var factor = direction > 0 ? 0.92 : 1.08;
            zoomAtCanvasPoint(factor, p);
          }, { passive:false });

          // initial state
          setCanvasSizeLocked();
          ctx = cvs.getContext("2d", { alpha:true });
          draw();
          updatePortraitButton();
        }

        // expose a tiny helper if needed later
        window.__drfb_openPortraitCropper = openPortrait;

        // wire at DOMContentLoaded (builder uses DOMContentLoaded already, but this is safe)
        document.addEventListener("DOMContentLoaded", wire);
      })();

document.addEventListener("DOMContentLoaded", function () {
        initStats();
        initWeaponsCC();
        initWeaponsRanged();
        initSimplePanel("section-abilities", "Fighter Abilities", FIGHTER_ABILITIES, "abilities", false, null);
        initSimplePanel("section-leader",   "Leader Abilities",  LEADER_ABILITIES,  "leaderAbilities", false, 2);
        initSimplePanel("section-spells",   "Spells",            SPELLS,            "spells", true, null);
        initSimplePanel("section-equipment","Equipment",         EQUIPMENT,         "equipment", false, null);
        refreshTotal();
        updateSummary();
        initTabs();
        setupJsonUi();
});
    })();
  </script>


<!-- Clean card renderer override (DOM-based; avoids template-literal string editing pitfalls) -->
<style id="darkrealms-clean-card-css">
  /* Overlay */
  #generated-card-overlay{
    position:fixed; inset:0; z-index:9999;
    display:none;
    background:#fff;
    overflow:auto;
    padding:24px;
    box-sizing:border-box;
    font-family: Arial, Helvetica, sans-serif;
    color:#111;
  }
  #generated-card-toolbar{
    max-width: 980px;
    margin: 0 auto 12px auto;
    display:flex;
    gap:10px;
    justify-content:flex-end;
    align-items:center;
  }
  #generated-card-toolbar button{
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid #222;
    background: #fff;
    font-weight: 800;
    cursor: pointer;
  }

  /* Card frame */
  .print-card.clean-card{
    width: 820px;
    height: 660px; /* 8:7 of 820 */
    margin: 0 auto;
    border: 2px solid #111;
    border-radius: 0;
    box-sizing: border-box;
    padding: 16px 18px 18px;
    overflow: hidden; /* fixed frame */
    display:flex;
    flex-direction:column;
    box-shadow: 0 10px 30px rgba(0,0,0,.18);
    background-repeat: no-repeat;
    background-size: cover;
  }

  .cc-logo{width:66%; max-width:260px; height:auto; display:none; margin: 0 auto; opacity:0.98;}

  /* --- Big portrait behind header + stat pills (stops before options pill) --- */
  .cc-topwrap{position:relative;}
  .cc-bg-portrait{
    position:absolute;
    top:0;
    left:50%;
    transform:translateX(-50%);
    height:100%;
    width:auto;
    max-width:none;
    z-index:1;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.75));
    pointer-events:none;
  }
  /* Ensure header + stats + HP pips render above portrait */
  .cc-header, .cc-stats{position:relative; z-index:5;}
  .cc-hp, .hp-pips{position:relative; z-index:6;}



.cc-header{
  display:grid;
  grid-template-columns: 260px 260px 260px; /* left | logo | right */
  align-items:start;
  gap:12px;
}
  .cc-header-left{justify-self:start;}
  .cc-header-center{justify-self:center; text-align:center;}
  .cc-header-right{width:260px;}

  
  .cc-leftpill{
    background: rgba(255,255,255,0.92);
    border: 1px solid black;
    border-radius: 14px;
    padding: 10px 8px;
    flex: 1 1 auto;
    box-sizing:border-box;
    width: 260px;
    max-width: 260px;
    margin-top: 20px;
    margin-left: 20px;
}
  .cc-name{font-weight: 900; font-size: 16px; margin-left: 12 px; margin-bottom: 1px; color:#111;}
  .cc-meta{font-size: 12px; color:#111;}
  .cc-right{
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:flex-end;
    flex: 0 0 auto;
  }
  .cc-pts{
    background: rgba(255,255,255,0.92);
    border: 1px solid black;
    border-radius: 14px;
    padding: 8px 10px;
    font-weight: 900;
    color:#111;
    min-width: 50px;
    text-align:center;
    margin-top: 20px;
    margin-right: 45px;
    margin-bottom: 30px;
  }
  .cc-hp{
    background: transparent;
    border: 0;
    border-radius: 0;
    padding: 0;
    align-items: center; 
    min-width: 110px;
    margin-right: 20px;
  }
  .hp-pips{
  display:grid;
  grid-template-columns: repeat(12, 20px);
  grid-auto-rows: 20px;
  gap: 4px 6px;
  min-width: 260px;
  display: flex;
  margin-left: auto;
  margin-right: 25px;
  align-content: start;
  justify-content: end;
  justify-items: end; /* prevents squish */
}
  .hp-pip{width:20px;height:20px;border-radius:50%;border:2px solid #111;background:#fff;box-sizing:border-box;}

  .cc-stats{
    margin-top: 12px;
    margin-left: 120px;
    margin-right: 120px; 
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(48px, 1fr));
    gap:22px;
  }
  .cc-stat{
    background: rgba(236,241,231,0.95);
    border: 1px solid black;
    border-radius: 14px;
    padding: 8px 6px;
    text-align:center;
  
    color:#111;
  }

  
  .cc-stat-label{font-size:12px; font-weight:800; opacity:0.85; margin-bottom:2px; text-transform: uppercase; color:#111;}
  .cc-stat-val{font-size:19px; font-weight:900; line-height:1.05; color:#111; display:block;}

  /* --- Weapons profile table (auto from selected weapons) --- */
  .cc-weapons{
    margin: 2px 2px 0 2px;
    background: transparent;
    border-bottom: 1px solid black;

    padding: 8px 10px;

    box-sizing: border-box;
  
    column-span: all;
    -webkit-column-span: all;
    break-inside: avoid;
    margin-bottom: 10px;
  }
  .cc-weapons table{ width:100%; border-collapse:collapse; font-size:13px; }
  .cc-weapons th{
    text-transform: uppercase;
    font-size: 13px;
    letter-spacing: 0.04em;
    text-align:left;
    border-bottom: 1px solid rgba(0,0,0,0.35);
    padding: 4px 6px;
  }
  .cc-weapons td{
    padding: 4px 6px;
    vertical-align: top;
    border-bottom: 1px solid rgba(0,0,0,0.15);
  }
  .cc-weapons tr:last-child td{ border-bottom:none; }
  .cc-weapons .wname{ font-weight: 900; width: 24%; } /* Weapon Title */
  .cc-weapons .wnum{ font-weight: 900; text-align:center; white-space:nowrap; }
  .cc-weapons .wrules{ font-weight: 600; }
/* Single options pill */
  .cc-options-pill{
    margin-top: 14px;
    flex: 1 1 auto;
    min-height: 0;
    display:flex;
    background: rgba(255,255,255,0.88);
    border: 1px solid black;
    border-radius: 14px;
    padding: 10px;
    padding-bottom: 20px;
    overflow: hidden;
    position: relative;
    position: relative; position: relative;
    box-sizing: border-box;
  }
  .cc-options-inner{
    flex:1;
    display:block;
    /* Two-column flow */
    column-count: 2;
    column-gap: 16px;
    column-fill: auto;
    /* Scalable typography */
    --opt-scale: 1;
    font-size: calc(13px * var(--opt-scale));
    line-height: calc(1.25 * var(--opt-scale));
    padding-bottom: 10px;
    
  }

.cc-weapons table thead th:nth-child(5),
.cc-weapons table tbody td:nth-child(5) {
  padding-left: 20px;
}
.cc-weapons table thead th:nth-child(4),
.cc-weapons table tbody td:nth-child(4) {
  padding-left: 10px;
}
    
  .cc-sec{break-inside:auto; page-break-inside:auto; margin: 0 0 18px 0;}
  .cc-sec-title{font-weight:900; margin: 0 0 6px 0; color:#111; font-size:1.15em;}

  .cc-sec + .cc-sec{
    border-top: 1px solid rgba(0,0,0,0.15);
    padding-top: 8px;
  }

  .cc-list{margin:0; padding-left: 18px;}
  .cc-item{margin: 0 0 6px 0;}

  .cc-muted{color:#555; font-weight: 600;}


    /* Don’t leave the title stranded at the bottom of a column */
.cc-sec-title{
  break-after: avoid-column;
  break-inside: avoid;
}

/* Keep the first item with the title (so you don’t get “title only”) */
.cc-sec > .cc-list > li:first-child,
.cc-sec > p:first-of-type,
.cc-sec > div:first-of-type {
  break-inside: avoid;
}

/* Optional: prevent an individual list item splitting (rare, but nice) */
.cc-list li{
  break-inside: avoid;
}


  @media print{
    body{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
    #generated-card-toolbar{display:none !important;}
    #generated-card-overlay{position:static; padding:0;}
    .print-card.clean-card{margin:0; box-shadow:none;}
  }
</style>

<script>
(function(){
  function esc(s){
    return (s==null?"":String(s))
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function brToText(html){
    return (html||"").replace(/<br\s*\/?>/gi,"\n").replace(/&nbsp;/g," ");
  }
  function renderRulesHtml(main){
    if (!main) return "";
    var txt = String(main).replace(/<br\s*\/?>/gi,"\n");
    var lines = txt.split(/\n+/);
    return lines.map(function(l){
      l = l.trim();
      return l ? "<div>" + esc(l) + "</div>" : "";
    }).join("");
  }
  function getBaseHref(){
    var href = (window.location && window.location.href) ? window.location.href : "";
    return href.replace(/[#?].*$/, "");
  }
  function buildHpPips(hp){
    var n = Math.max(0, Math.min(99, parseInt(hp||0,10)||0));
    var wrap = document.createElement("span");
    wrap.className = "hp-pips";
    for (var i=0;i<n;i++){
      var d = document.createElement("span");
      d.className = "hp-pip";
      wrap.appendChild(d);
    }
    return wrap;
  }

  function ensureOverlay(){
    var ov = document.getElementById("generated-card-overlay");
    if (!ov){
      ov = document.createElement("div");
      ov.id = "generated-card-overlay";
      document.body.appendChild(ov);
    }
    return ov;
  }

  // Replace the existing Generate Card with a clean DOM-based renderer.
  window.generateFighterCard = function(){
    try{
      var ov = ensureOverlay();
      ov.innerHTML = "";

      // toolbar
      var tb = document.createElement("div");
      tb.id = "generated-card-toolbar";

      // texture toggle (card background)
      var texWrap = document.createElement("label");
      texWrap.className = "cc-tex-toggle";
      var texChk = document.createElement("input");
      texChk.type = "checkbox";
      texChk.checked = (localStorage.getItem("dr_card_texture") !== "0");
      var texTxt = document.createElement("span");
      texTxt.textContent = "Texture";
      texWrap.appendChild(texChk);
      texWrap.appendChild(texTxt);


      var btnBack = document.createElement("button");
      btnBack.textContent = "Back";
      btnBack.onclick = function(){
        ov.style.display = "none";
        document.body.classList.remove("print-card-mode");
        document.body.style.overflow = "";
      };

      var btnPrint = document.createElement("button");
      btnPrint.textContent = "Print";
      btnPrint.onclick = function(){ window.print(); };

      tb.appendChild(texWrap);
      tb.appendChild(btnBack);
      tb.appendChild(btnPrint);
      ov.appendChild(tb);

      // base URLs for assets (same as existing builder approach)
      var baseHref = getBaseHref();
      var logoUrl = (window.DARKREALMS_CARD_LOGO_URL) ? (new URL(window.DARKREALMS_CARD_LOGO_URL, baseHref)).href : "";
      var texUrl  = (window.DARKREALMS_CARD_TEX_URL) ? (new URL(window.DARKREALMS_CARD_TEX_URL, baseHref)).href : "";

      // card
      var card = document.createElement("div");
      card.className = "print-card clean-card";
      function applyTexture(){
        var on = (localStorage.getItem("dr_card_texture") !== "0");
        if (on && texUrl) { card.style.backgroundImage = "url('" + texUrl + "')"; }
        else { card.style.backgroundImage = "none"; }
      }
      texChk.addEventListener("change", function(){
        localStorage.setItem("dr_card_texture", this.checked ? "1" : "0");
        applyTexture();
      });
      applyTexture();

      // logo + portrait
      // If a portrait exists, we render it as a BIG background image behind the header + stat pills
      // (wrapped in .cc-topwrap so it naturally stops before the options pill).
      var hasPortrait = fighter && fighter.portraitDataUrl && String(fighter.portraitDataUrl).trim();

      var bgPortrait = null;
      if (hasPortrait) {
        bgPortrait = document.createElement("img");
        bgPortrait.className = "cc-bg-portrait";
        bgPortrait.src = String(fighter.portraitDataUrl).trim();
        bgPortrait.alt = "Portrait";
        bgPortrait.onerror = function(){ this.style.display = "none"; };
      }

      // Keep the header logo slot empty when portrait is present (saves space / avoids overlap)
      var logo = document.createElement("img");
      logo.className = "cc-logo";
      logo.onerror = function(){ this.style.display="none"; };
      if (!hasPortrait && logoUrl) {
        logo.src = logoUrl;
        logo.alt = "Mortalis";
      } else {
        logo.style.display = "none";
        logo.alt = "Logo";
      }
      // name + points
      var nm = (fighter.name && fighter.name.trim()) ? fighter.name.trim() : "Fighter";
      var total = computeTotal ? computeTotal() : 0;
      var psyLabel = "None";
      if (fighter.isMasterWarlock) psyLabel = "Master Warlock";
      else if (fighter.isWarlock) psyLabel = "Warlock";

      // Header grid: Name | Logo | Points/HP
      var header = document.createElement("div");
      header.className = "cc-header";

      var headerLeft = document.createElement("div");
      headerLeft.className = "cc-header-left";

      var headerCenter = document.createElement("div");
      headerCenter.className = "cc-header-center";
      headerCenter.appendChild(logo);

      var headerRight = document.createElement("div");
      headerRight.className = "cc-header-right";

      var left = document.createElement("div");
      left.className = "cc-leftpill";
      var nameEl = document.createElement("div");
      nameEl.className = "cc-name";
      nameEl.textContent = nm;
      var metaEl = document.createElement("div");
      metaEl.className = "cc-meta";
      left.appendChild(nameEl);
      headerLeft.appendChild(left);
      var right = document.createElement("div");
      right.className = "cc-right";
      var pts = document.createElement("div");
      pts.className = "cc-pts";
      pts.textContent = total + " pts";

      var hpBox = document.createElement("div");
      hpBox.className = "cc-hp";
      var hp = (fighter.stats && (fighter.stats.HP!=null)) ? fighter.stats.HP : (fighter.stats && fighter.stats.hp!=null ? fighter.stats.hp : 0);
      var hpLabel = document.createElement("span");
      hpLabel.textContent = "";
      hpBox.appendChild(hpLabel);
      hpBox.appendChild(buildHpPips(hp));

      right.appendChild(pts);
      right.appendChild(hpBox);
      headerRight.appendChild(right);

      header.appendChild(headerLeft);
      header.appendChild(headerCenter);
      header.appendChild(headerRight);

      // Wrap header + stats so the big portrait background naturally stops before options pill
      var topWrap = document.createElement("div");
      var pendingWeaponsWrap = null;
      topWrap.className = "cc-topwrap";
      if (bgPortrait) topWrap.appendChild(bgPortrait);
      topWrap.appendChild(header);

      // stats pills
      var statsWrap = document.createElement("div");
      statsWrap.className = "cc-stats";
      var s = fighter.stats || {};
      // order (attempt common Mortalis order; fall back to existing keys)
      var order = ["Move","M","DEF","Defense","AP","HP","ATK","Attack","Fight","Shoot"];
      var used = {};
      order.forEach(function(k){
                var _kl = String(k).toLowerCase();
        if (_kl === 'atk' || _kl === 'attack' || _kl === 'fight' || _kl === 'shoot') return;
var v = (s[k]!=null)?s[k]:null;
        if (v==null) return;
        used[k]=true;
        var p = document.createElement("div");
        p.className = "cc-stat";
       var _k = String(k).toLowerCase();
var _vv = String(v ?? "");
if (_k === "move") _vv += '"';
else if (_k === "def" || _k === "fight" || _k === "shoot") _vv += '+';

p.innerHTML = "<div class=\"cc-stat-label\">" + esc(k) + "</div><div class=\"cc-stat-val\">" + esc(_vv) + "</div>";
        statsWrap.appendChild(p);
      });
      Object.keys(s).forEach(function(k){
                var _kl2 = String(k).toLowerCase();
        if (_kl2 === 'atk' || _kl2 === 'attack' || _kl2 === 'fight' || _kl2 === 'shoot') return;
if (used[k]) return;
        var p = document.createElement("div");
        p.className = "cc-stat";
       var _k = String(k).toLowerCase();
var _vv = String((s && s[k] != null) ? s[k] : "");
if (_k === "move") _vv += '"';
else if (_k === "def" || _k === "fight" || _k === "shoot") _vv += '+';

p.innerHTML = "<div class=\"cc-stat-label\">" + esc(k) + "</div><div class=\"cc-stat-val\">" + esc(_vv) + "</div>";
        statsWrap.appendChild(p);
      });
      
// weapons profile table (auto; flexible rows)
function pickStat(keys){
  for (var i=0;i<keys.length;i++){
    var kk = keys[i];
    if (s && s[kk] != null) return s[kk];
  }
  return null;
}
function fmtPlus(v){
  if (v == null || v === "") return "";
  return String(v) + "+";
}
function parseAtk(profile){
  var m = String(profile||"").match(/\bATK\s*([^,]+)/i);
  return m ? m[1].trim() : "";
}
function parseDmg(profile){
  var m = String(profile||"").match(/\bDMG\s*([^,]+)/i);
  return m ? m[1].trim() : "";
}
function stripProfile(p){
  if (!p) return "";
  var parts = String(p).split(",").map(function(x){return x.trim();}).filter(Boolean);
  parts = parts.filter(function(x){
    var xl = x.toLowerCase();
    if (xl.startsWith("atk")) return false;
    if (xl.startsWith("hit")) return false;
    if (xl.startsWith("dmg")) return false;
    return true;
  });
  return parts.join(", ");
}
var atkVal   = pickStat(["ATK","Attack","atk","attack"]);
var fightVal = pickStat(["Fight","fight"]);
var shootVal = pickStat(["Shoot","shoot"]);
var weaponRows = [];

(fighter.ccWeapons||[]).forEach(function(w){
  var prof = (w && (w.profile || w.effect)) || "";
  weaponRows.push({
    name:  w ? String(getDisplayName(w)) : "",
    atk:   (atkVal!=null ? String(atkVal) : ""),
    dmg:   parseDmg(prof),
    hit:   fmtPlus(fightVal),
    rules: stripProfile(prof)
  });
});

(fighter.rangedWeapons||[]).forEach(function(w){
  var prof = (w && (w.profile || w.effect)) || "";
  weaponRows.push({
    name:  w ? String(getDisplayName(w)) : "",
    atk:   parseAtk(prof),
    dmg:   parseDmg(prof),
    hit:   fmtPlus(shootVal),
    rules: stripProfile(prof)
  });
});

if (weaponRows.length){
  var wWrap = document.createElement("div");
  wWrap.className = "cc-weapons";
  var t = document.createElement("table");
  var thead = document.createElement("thead");
  thead.innerHTML = "<tr>"
    + "<th>Weapon</th>"
    + "<th style=\"width:80px; text-align:center;\">ATK</th>"
    + "<th style=\"width:80px; text-align:center;\">To Hit</th>"
    + "<th style=\"width:80px; text-align:center;\">DMG</th>"
    + "<th>Special Rules</th>"
    + "</tr>";
  t.appendChild(thead);

  var tbody = document.createElement("tbody");
  weaponRows.forEach(function(r){
    var tr = document.createElement("tr");

    var tdN = document.createElement("td");
    tdN.className = "wname";
    tdN.textContent = r.name || "";
    tr.appendChild(tdN);

    var tdA = document.createElement("td");
    tdA.className = "wnum";
    tdA.textContent = (r.atk!=null ? String(r.atk) : "");
    tr.appendChild(tdA);

    var tdH = document.createElement("td");
    tdH.className = "wnum";
    tdH.textContent = (r.hit!=null ? String(r.hit) : "");
    tr.appendChild(tdH);

    var tdD = document.createElement("td");
    tdD.className = "wnum";
    tdD.textContent = (r.dmg!=null ? String(r.dmg) : "");
    tr.appendChild(tdD);

    var tdR = document.createElement("td");
    tdR.className = "wrules";
    tdR.textContent = r.rules || "";
    tr.appendChild(tdR);

    tbody.appendChild(tr);
  });
  t.appendChild(tbody);
  wWrap.appendChild(t);
  pendingWeaponsWrap = wWrap;
}
      topWrap.appendChild(statsWrap);
      card.appendChild(topWrap);

      // options pill
      var optPill = document.createElement("div");
      optPill.className = "cc-options-pill";
      var optInner = document.createElement("div");
      optInner.className = "cc-options-inner";
      optPill.appendChild(optInner);
      card.appendChild(optPill);

      
      if (pendingWeaponsWrap) { optInner.appendChild(pendingWeaponsWrap); }
function addSection(title, arr, mainKey){
        if (!arr || !arr.length) return;
        var sec = document.createElement("div");
        sec.className = "cc-sec";
        var t = document.createElement("div");
        t.className = "cc-sec-title";
        t.textContent = title;
        sec.appendChild(t);

        var ul = document.createElement("ul");
        ul.className = "cc-list";
        arr.forEach(function(x){
          var li = document.createElement("li");
          li.className = "cc-item";
          var pts = x.points || 0;
          var meta = (title === "Spells")
            ? ("CV " + (x.cv != null ? x.cv : ""))
            : (pts + " pts");
          var main = x.profile || x.effect || "";
          var rulesHtml = renderRulesHtml(main);
          li.innerHTML = "<b>" + esc(getDisplayName(x)) + "</b> <span class='cc-muted'>(" + meta + ")</span>" +
                         (rulesHtml ? "<br><span class='cc-muted'>" + rulesHtml + "</span>" : "");
          ul.appendChild(li);
        });
        sec.appendChild(ul);
        optInner.appendChild(sec);
      }
addSection("Abilities", fighter.abilities);
      addSection("Leader Abilities", fighter.leaderAbilities);
      addSection("Spells", fighter.spells);
      addSection("Equipment", fighter.equipment);

      // mount
      ov.appendChild(card);
      ov.style.display = "block";
      document.body.classList.add("print-card-mode");
      document.body.style.overflow = "hidden";

      // autoscale only options: use scrollWidth overflow from columns
      function fitOptions(){
        try{
          var cs = window.getComputedStyle(optPill);
          var padL = parseFloat(cs.paddingLeft)  || 0;
          var padR = parseFloat(cs.paddingRight) || 0;
          var padT = parseFloat(cs.paddingTop)   || 0;
          var padB = parseFloat(cs.paddingBottom)|| 0;

          // Available content box inside the padded pill
          var availH = Math.max(0, optPill.clientHeight - padT - padB);
          var availW = Math.max(0, optPill.clientWidth  - padL - padR);

          optInner.style.boxSizing = "border-box";
          optInner.style.height = availH + "px";
          optInner.style.width  = availW + "px";

          function applyScale(s){
            optInner.style.setProperty("--opt-scale", s.toFixed(4));
          }
          function fits(){
            var w = optInner.scrollWidth || 0;
            var h = optInner.scrollHeight || 0;
            return (w <= availW + 1) && (h <= availH + 1);
          }

          applyScale(1.0);
          if (fits()) return;

          var lo = 0.20, hi = 1.0, best = 0.20;
          for (var i=0;i<14;i++){
            var mid = (lo + hi) / 2;
            applyScale(mid);
            if (fits()){
              best = mid;
              lo = mid;
            } else {
              hi = mid;
            }
          }
          applyScale(best);

          // Safety: never draw outside pill
          optInner.style.overflow = "hidden";
        }catch(e){}
      }
      function fitSoon(){
        requestAnimationFrame(function(){ requestAnimationFrame(fitOptions); });
      }
      fitSoon();
      // re-fit after logo image loads (affects layout) and after a short delay
      try{ logo.addEventListener("load", fitSoon); }catch(e){}
      setTimeout(fitSoon, 120);
      // re-fit on resize while overlay is open
      window.addEventListener("resize", function(){
        if (ov && ov.style && ov.style.display === "block") fitSoon();
      }, { passive:true });

      requestAnimationFrame(function(){ requestAnimationFrame(fitOptions); });

    }catch(e){
      alert("Generate Card failed: " + e);
    }
  };
})();
</script>



<script>

// --- Display name override helper (cosmetic only) ---
function getDisplayName(item){
  if(!item) return "";
  if(typeof item === "string") return item;
  var n = (item.displayNameOverride != null ? String(item.displayNameOverride) : "").trim();
  if(n) return n;
  return (item.name != null ? String(item.name) : "");
}
window.getDisplayName = window.getDisplayName || getDisplayName;


// Back-compat alias
window.printFighterCard = function(){ if (window.generateFighterCard) return window.generateFighterCard(); };

</script>

</body>
</html>
